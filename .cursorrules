# Project Management Automation - AI Agent Rules

## üö® CRITICAL: Use `uv` for Python Package Management

**This project uses `uv` for all Python package management. NEVER use `pip` or manually create virtual environments.**

### Package Installation & Environment Setup

**ALWAYS use `uv` commands:**
- `uv sync` - Install dependencies and sync environment (replaces `pip install`)
- `uv run <command>` - Run commands in the managed environment
- `uv pip install` - Only if you must use pip-compatible commands (still uses uv)
- `uvx <package>` - Run packages without installation (like npx for Python)

**NEVER use:**
- ‚ùå `pip install` (use `uv sync` or `uv pip install` instead)
- ‚ùå `python -m venv` (uv manages environments automatically)
- ‚ùå `source venv/bin/activate` (use `uv run` instead)
- ‚ùå Manual virtual environment creation

### Development Setup

```bash
# Install dependencies (replaces: pip install -e '.[dev]')
uv sync

# Run commands in the environment
uv run exarp --version
uv run pytest tests/
uv run black .
```

### Why `uv`?

- **10-100x faster** than pip
- **Automatic environment management** (no manual venv creation)
- **Better dependency resolution** with lockfile support
- **Project already configured** with `uv.lock` file

### Project Structure

- `uv.lock` - Dependency lockfile (commit this!)
- `pyproject.toml` - Project configuration
- `.venv/` - Managed by uv (don't manually modify)

## Development Workflow

1. **Setup**: `uv sync` (one-time setup)
2. **Run commands**: `uv run <command>` (always use this)
3. **Install new deps**: Add to `pyproject.toml`, then `uv sync`
4. **Update deps**: `uv sync --upgrade`

## Testing

```bash
uv run pytest tests/ -v
uv run pytest tests/ --cov
```

## Code Quality

```bash
uv run black .
uv run ruff check .
uv run mypy .
```

## Running the Server

```bash
uv run exarp --version
uv run python -m project_management_automation.server
```

## If `uv` is Not Available

If `uv` is not installed, inform the user and suggest:
```bash
# Install uv
curl -LsSf https://astral.sh/uv/install.sh | sh
# Or via pipx
pipx install uv
```

Then proceed with `uv` commands.

## üö® CRITICAL: Task Management via MCP Tools

**NEVER directly edit `.todo2/state.todo2.json` or any Todo2 files manually.**

**ALWAYS use agentic-tools MCP server for task operations:**
- ‚úÖ `mcp_agentic-tools_create_task` - Create new tasks
- ‚úÖ `mcp_agentic-tools_update_task` - Update existing tasks
- ‚úÖ `mcp_agentic-tools_list_tasks` - List tasks
- ‚úÖ `mcp_agentic-tools_get_task` - Get task details
- ‚ùå NEVER: Direct JSON file manipulation
- ‚ùå NEVER: Manual file editing for task management

**Why?**
- Ensures proper validation and consistency
- Maintains task relationships and metadata
- Works with the project's task management system
- Follows the established architecture

**Example:**
```python
# ‚úÖ CORRECT: Use MCP tool
mcp_agentic-tools_create_task(
    workingDirectory="/path/to/project",
    projectId="project-id",
    name="Task name",
    details="Task details",
    status="pending",
    priority=5
)

# ‚ùå WRONG: Direct file manipulation
# with open('.todo2/state.todo2.json') as f:
#     data = json.load(f)
#     data['todos'].append(new_task)
```

## üö® CRITICAL: FastMCP Return Type Requirements

**ALL MCP tools and resources MUST return JSON strings, NEVER dicts.**

**Pattern to ALWAYS use:**
```python
@mcp.tool()
def my_tool(...) -> str:
    """Tool description."""
    try:
        result = some_function()
        # Ensure we always return a JSON string
        if isinstance(result, str):
            return result
        elif isinstance(result, dict):
            return json.dumps(result, indent=2)
        else:
            return json.dumps({"result": str(result)}, indent=2)
    except Exception as e:
        return json.dumps({"error": str(e)}, indent=2)
```

**Why?**
- FastMCP expects strings, not dicts
- Prevents "object dict can't be used in 'await' expression" errors
- Ensures consistent return types across all tools/resources

**Files to check:**
- All `@mcp.tool()` decorated functions ‚Üí Must return `str`
- All `@mcp.resource()` decorated functions ‚Üí Must return `str`
- Prompts are fine (they return template strings)

**Common mistakes:**
- ‚ùå Returning `dict` directly
- ‚ùå Returning `dict | str` union type
- ‚ùå Forgetting to convert dict to JSON string
- ‚úÖ Always return `str` with JSON content

