# GitLab CI/CD Configuration for Exarp
# Enables security scanning on mirrored repository
# This file is synced from GitHub and runs on GitLab

include:
  # Security scanning templates (free on GitLab)
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml

stages:
  - test
  - security

variables:
  SAST_DISABLED: "false"
  DEPENDENCY_SCANNING_DISABLED: "false"
  SECRET_DETECTION_DISABLED: "false"

# Python-specific SAST
sast:
  stage: security
  variables:
    SAST_EXCLUDED_PATHS: "build/,.venv/,venv/,__pycache__/"
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - "**/*.py"

# Python security scanning with Bandit
bandit-sast:
  variables:
    SAST_BANDIT_EXCLUDED_PATHS: "tests/"

# Semgrep for Python
semgrep-sast:
  variables:
    SEMGREP_RULES: "p/python p/security-audit"

# Dependency scanning for Python
dependency_scanning:
  stage: security
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - "requirements.txt"
        - "pyproject.toml"
        - "setup.py"

# Secret detection
secret_detection:
  stage: security
  variables:
    SECRET_DETECTION_EXCLUDED_PATHS: ".venv/,venv/"
  rules:
    - if: $CI_COMMIT_BRANCH

# License compliance
license_scanning:
  stage: security
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - "requirements.txt"
        - "pyproject.toml"

# Python tests (optional - uncomment if you want GitLab to also run tests)
# python_tests:
#   stage: test
#   image: python:3.11
#   script:
#     - pip install -e ".[dev]"
#     - pytest tests/ -v
#   rules:
#     - if: $CI_COMMIT_BRANCH

# Verify mirror is working
verify_mirror:
  stage: test
  script:
    - echo "âœ… GitLab mirror is working!"
    - echo "Repository: $CI_PROJECT_NAME (Exarp)"
    - echo "Branch: $CI_COMMIT_BRANCH"
    - echo "Commit: $CI_COMMIT_SHA"
  rules:
    - if: $CI_COMMIT_BRANCH

