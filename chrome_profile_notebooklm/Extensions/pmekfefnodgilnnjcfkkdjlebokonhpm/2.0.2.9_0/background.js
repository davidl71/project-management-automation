import { n, b as bn, y as yn, _ as _m, a as bm, w as wm, T as Tm, S as Sm, I as Im, t as te$1, X as X$1, h as ht, c as ne$1, Z as Z$1, J as J$1, e as ee$1, Q as Q$1, H as H$1, V as V$1, O, M as Mt, d as It, v as vn, G as G$1, K as Ke$1, i as it$1, Y as Ye$1, f as Ze$1, U, q as q$1, g as dt, j as ft, k as Xe$1, p as pt, l as Ge$1, z, m as vt } from './chunks/Utils-d38e56d0.js';
import { u, c } from './chunks/AOUnblockedList-a1d52d17.js';
import './chunks/jquery-e1fc36eb.js';

/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class _{static deserialize(e){return new _({debug:e.getBool(),enableCompression:e.getBool(),enableHtmlFiltering:e.getBool(),enableInMemoryCache:e.getBool(),enableMutationObserver:e.getBool(),enableOptimizations:e.getBool(),enablePushInjectionsOnNavigationEvents:e.getBool(),guessRequestTypeFromUrl:e.getBool(),integrityCheck:e.getBool(),loadCSPFilters:e.getBool(),loadCosmeticFilters:e.getBool(),loadExceptionFilters:e.getBool(),loadExtendedSelectors:e.getBool(),loadGenericCosmeticsFilters:e.getBool(),loadNetworkFilters:e.getBool(),loadPreprocessors:e.getBool()})}constructor({debug:e=!1,enableCompression:t=!1,enableHtmlFiltering:s=!1,enableInMemoryCache:i=!0,enableMutationObserver:r=!0,enableOptimizations:n=!0,enablePushInjectionsOnNavigationEvents:o=!0,guessRequestTypeFromUrl:l=!1,integrityCheck:a=!0,loadCSPFilters:c=!0,loadCosmeticFilters:h=!0,loadExceptionFilters:d=!0,loadExtendedSelectors:u=!1,loadGenericCosmeticsFilters:p=!0,loadNetworkFilters:f=!0,loadPreprocessors:g=!1}={}){this.debug=e,this.enableCompression=t,this.enableHtmlFiltering=s,this.enableInMemoryCache=i,this.enableMutationObserver=r,this.enableOptimizations=n,this.enablePushInjectionsOnNavigationEvents=o,this.guessRequestTypeFromUrl=l,this.integrityCheck=a,this.loadCSPFilters=c,this.loadCosmeticFilters=h,this.loadExceptionFilters=d,this.loadExtendedSelectors=u,this.loadGenericCosmeticsFilters=p,this.loadNetworkFilters=f,this.loadPreprocessors=g;}getSerializedSize(){return 16*O()}serialize(e){e.pushBool(this.debug),e.pushBool(this.enableCompression),e.pushBool(this.enableHtmlFiltering),e.pushBool(this.enableInMemoryCache),e.pushBool(this.enableMutationObserver),e.pushBool(this.enableOptimizations),e.pushBool(this.enablePushInjectionsOnNavigationEvents),e.pushBool(this.guessRequestTypeFromUrl),e.pushBool(this.integrityCheck),e.pushBool(this.loadCSPFilters),e.pushBool(this.loadCosmeticFilters),e.pushBool(this.loadExceptionFilters),e.pushBool(this.loadExtendedSelectors),e.pushBool(this.loadGenericCosmeticsFilters),e.pushBool(this.loadNetworkFilters),e.pushBool(this.loadPreprocessors);}}let j;const M="undefined"!=typeof window&&"function"==typeof window.queueMicrotask?e=>window.queueMicrotask(e):e=>(j||(j=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0)))
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */;function G(e,t,s){let i=s.get(e);void 0===i&&(i=[],s.set(e,i)),i.push(t);}function $(e,t,s){const i=s.get(e);if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1);}}function H(e,t,s){if(0===s.size)return !1;const i=s.get(e);return void 0!==i&&(M((()=>{for(const e of i)e(...t);})),!0)}class q{constructor(){this.onceListeners=new Map,this.onListeners=new Map;}on(e,t){G(e,t,this.onListeners);}once(e,t){G(e,t,this.onceListeners);}unsubscribe(e,t){$(e,t,this.onListeners),$(e,t,this.onceListeners);}emit(e,...t){H(e,t,this.onListeners),!0===H(e,t,this.onceListeners)&&this.onceListeners.delete(e);}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class V{constructor(){this.options=new Set,this.prefix=void 0,this.infix=void 0,this.suffix=void 0,this.redirect=void 0;}blockRequestsWithType(e){if(this.options.has(e))throw new Error(`Already blocking type ${e}`);return this.options.add(e),this}images(){return this.blockRequestsWithType("image")}scripts(){return this.blockRequestsWithType("script")}frames(){return this.blockRequestsWithType("frame")}fonts(){return this.blockRequestsWithType("font")}medias(){return this.blockRequestsWithType("media")}styles(){return this.blockRequestsWithType("css")}redirectTo(e){if(void 0!==this.redirect)throw new Error(`Already redirecting: ${this.redirect}`);return this.redirect=`redirect=${e}`,this}urlContains(e){if(void 0!==this.infix)throw new Error(`Already matching pattern: ${this.infix}`);return this.infix=e,this}urlStartsWith(e){if(void 0!==this.prefix)throw new Error(`Already matching prefix: ${this.prefix}`);return this.prefix=`|${e}`,this}urlEndsWith(e){if(void 0!==this.suffix)throw new Error(`Already matching suffix: ${this.suffix}`);return this.suffix=`${e}|`,this}withHostname(e){if(void 0!==this.prefix)throw new Error(`Cannot match hostname if filter already has prefix: ${this.prefix}`);return this.prefix=`||${e}^`,this}toString(){const e=[];void 0!==this.prefix&&e.push(this.prefix),void 0!==this.infix&&e.push(this.infix),void 0!==this.suffix&&e.push(this.suffix);const t=["important"];if(0!==this.options.size)for(const e of this.options)t.push(e);return void 0!==this.redirect&&t.push(this.redirect),`${0===e.length?"*":e.join("*")}$${t.join(",")}`}}function W(){return new V}class K extends Map{}function Z(e){return e.length<6||33!==e.charCodeAt(0)||35!==e.charCodeAt(1)?0:e.startsWith("!#if ")?1:e.startsWith("!#else")?2:e.startsWith("!#endif")?3:0}const X=/(!|&&|\|\||\(|\)|[a-zA-Z0-9_]+)/g,Q=/^[a-zA-Z0-9_]+$/,Y={"!":2,"&&":1,"||":0},J=e=>Object.prototype.hasOwnProperty.call(Y,e),ee=(e,t)=>"true"===e&&!t.has("true")||!("false"===e&&!t.has("false"))&&!!t.get(e),te=(e,t)=>{if(0===e.length)return !1;if((e=>Q.test(e))(e))return "!"===e[0]?!ee(e.slice(1),t):ee(e,t);const s=(e=>e.match(X))(e);if(!s||0===s.length)return !1;if(e.length!==s.reduce(((e,t)=>e+t.length),0))return !1;const i=[],r=[];for(const e of s)if("("===e)r.push(e);else if(")"===e){for(;0!==r.length&&"("!==r[r.length-1];)i.push(r.pop());if(0===r.length)return !1;r.pop();}else if(J(e)){for(;r.length&&J(r[r.length-1])&&Y[e]<=Y[r[r.length-1]];)i.push(r.pop());r.push(e);}else i.push(ee(e,t));if("("===r[0]||")"===r[0])return !1;for(;0!==r.length;)i.push(r.pop());for(const e of i)if(!0===e||!1===e)r.push(e);else if("!"===e)r.push(!r.pop());else if(J(e)){const t=r.pop(),s=r.pop();"&&"===e?r.push(s&&t):r.push(s||t);}return !0===r[0]};class se{static getCondition(e){return e.slice(5).replace(/\s/g,"")}static parse(e,t){return new this({condition:se.getCondition(e),filterIDs:t})}static deserialize(e){const t=e.getUTF8(),s=new Set;for(let t=0,i=e.getUint32();t<i;t++)s.add(e.getUint32());return new this({condition:t,filterIDs:s})}constructor({condition:e,filterIDs:t=new Set}){this.condition=e,this.filterIDs=t;}evaluate(e){return te(this.condition,e)}serialize(e){e.pushUTF8(this.condition),e.pushUint32(this.filterIDs.size);for(const t of this.filterIDs)e.pushUint32(t);}getSerializedSize(){let e=G$1(this.condition);return e+=4*(1+this.filterIDs.size),e}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function ie(e){if(0===e.length||1===e.length)return 0;const t=e.charCodeAt(0),s=e.charCodeAt(1);if(33===t||35===t&&s<=32||91===t&&Ye$1(e,"[Adblock"))return 0;const i=e.charCodeAt(e.length-1);if(36===t||38===t||42===t||45===t||46===t||47===t||58===t||61===t||63===t||64===t||95===t||124===t||124===i)return 1;const o=e.indexOf("$");if(-1!==o&&o!==e.length-1){const t=o+1,s=e.charCodeAt(t);if(36===s||64===s&&Ze$1(e,"@$",t))return 0}const l=e.indexOf("#");if(-1!==l&&l!==e.length-1){const t=l+1,s=e.charCodeAt(t);if(35===s||64===s&&Ze$1(e,"@#",t))return 2;if(64===s&&(Ze$1(e,"@$#",t)||Ze$1(e,"@%#",t))||37===s&&Ze$1(e,"%#",t)||36===s&&Ze$1(e,"$#",t)||63===s&&Ze$1(e,"?#",t))return 0}return 1}function re(e,t=new _){t=new _(t);const r=[],n=[],o=e.split("\n"),l=[],a=[];for(let e=0;e<o.length;e+=1){let c=o[e];if(0!==c.length&&c.charCodeAt(0)<=32&&(c=c.trim()),c.length>2)for(;e<o.length-1&&92===c.charCodeAt(c.length-1)&&32===c.charCodeAt(c.length-2);){c=c.slice(0,-2);const t=o[e+1];if(!(t.length>4&&32===t.charCodeAt(0)&&32===t.charCodeAt(1)&&32===t.charCodeAt(2)&&32===t.charCodeAt(3)&&32!==t.charCodeAt(4)))break;c+=t.slice(4),e+=1;}0!==c.length&&c.charCodeAt(c.length-1)<=32&&(c=c.trim());const h=ie(c);if(1===h&&!0===t.loadNetworkFilters){const e=Mt.parse(c,t.debug);null!==e&&(r.push(e),a.length>0&&a[a.length-1].filterIDs.add(e.getId()));}else if(2===h&&!0===t.loadCosmeticFilters){const e=It.parse(c,t.debug);null!==e&&(!0!==t.loadGenericCosmeticsFilters&&!1!==e.isGenericHide()||(n.push(e),a.length>0&&a[a.length-1].filterIDs.add(e.getId())));}else if(t.loadPreprocessors){const e=Z(c);if(1===e)a.length>0?a.push(new se({condition:`(${a[a.length-1].condition})&&(${se.getCondition(c)})`})):a.push(se.parse(c));else if((3===e||2===e)&&a.length>0){const t=a.pop();l.push(t),2===e&&a.push(new se({condition:`!(${t.condition})`}));}}}return {networkFilters:r,cosmeticFilters:n,preprocessors:l.filter((e=>e.filterIDs.size>0))}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class ne{static deserialize(e){const t=e.getASCII(),s=new Map,i=e.getUint16();for(let t=0;t<i;t+=1)s.set(e.getASCII(),{contentType:e.getASCII(),body:e.getUTF8()});const r=new Map;return s.forEach((({contentType:e,body:t},s)=>{"application/javascript"===e&&r.set(s,t);})),new ne({checksum:t,js:r,resources:s})}static parse(e,{checksum:t}){const s=new Map,i=e.split("\n\n");for(const e of i){const t=(r=e,r.replace(/^\s*#.*$/gm,"")).trim();if(0!==t.length){const e=t.indexOf("\n"),i=t.slice(0,e).split(/\s+/),r=i[0],n=i[1],o=t.slice(e+1);if(void 0===r||void 0===n||void 0===o)continue;let l=s.get(n);void 0===l&&(l=new Map,s.set(n,l)),l.set(r,o);}}var r;const n=s.get("application/javascript")||new Map;for(const[e,t]of n.entries())e.endsWith(".js")&&n.set(e.slice(0,-3),t);const o=new Map;return s.forEach(((e,t)=>{e.forEach(((e,s)=>{o.set(s,{contentType:t,body:e});}));})),new ne({checksum:t,js:n,resources:o})}constructor({checksum:e="",js:t=new Map,resources:s=new Map}={}){this.checksum=e,this.js=t,this.resources=s;}getResource(e){const{body:t,contentType:s}=this.resources.get(e)||vn(e);let i;var r;return i=-1!==s.indexOf(";")?`data:${s},${t}`:`data:${s};base64,${r=t,"undefined"!=typeof btoa?btoa(r):"undefined"!=typeof Buffer?Buffer.from(r).toString("base64"):r}`,{body:t,contentType:s,dataUrl:i}}getSerializedSize(){let e=V$1(this.checksum)+2*H$1();return this.resources.forEach((({contentType:s,body:i},r)=>{e+=V$1(r)+V$1(s)+G$1(i);})),e}serialize(e){e.pushASCII(this.checksum),e.pushUint16(this.resources.size),this.resources.forEach((({contentType:t,body:s},i)=>{e.pushASCII(i),e.pushASCII(t),e.pushUTF8(s);}));}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */const oe=new Uint32Array(0);function le(e){return `(?:${e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")})`}function ae(e,t,s){let i=e.get(t);void 0===i&&(i=[],e.set(t,i)),i.push(s);}function ce(e,t){const s=new Map;for(const i of e)ae(s,t(i),i);return Array.from(s.values())}function he(e,t){const s=[],i=[];for(const r of e)t(r)?s.push(r):i.push(r);return {negative:i,positive:s}}const de=[{description:"Remove duplicated filters by ID",fusion:e=>e[0],groupByCriteria:e=>""+e.getId(),select:()=>!0},{description:"Group idential filter with same mask but different domains in single filters",fusion:e=>{const t=[],i=new Set,r=new Set,n=new Set,o=new Set;for(const{domains:s}of e)if(void 0!==s){if(void 0!==s.parts&&t.push(s.parts),void 0!==s.hostnames)for(const e of s.hostnames)i.add(e);if(void 0!==s.entities)for(const e of s.entities)n.add(e);if(void 0!==s.notHostnames)for(const e of s.notHostnames)r.add(e);if(void 0!==s.notEntities)for(const e of s.notEntities)o.add(e);}return new Mt(Object.assign({},e[0],{domains:new pt({hostnames:0!==i.size?new Uint32Array(i).sort():void 0,entities:0!==n.size?new Uint32Array(n).sort():void 0,notHostnames:0!==r.size?new Uint32Array(r).sort():void 0,notEntities:0!==o.size?new Uint32Array(o).sort():void 0,parts:0!==t.length?t.join(","):void 0}),rawLine:void 0!==e[0].rawLine?e.map((({rawLine:e})=>e)).join(" <+> "):void 0}))},groupByCriteria:e=>e.getHostname()+e.getFilter()+e.getMask()+e.getRedirect(),select:e=>!e.isCSP()&&void 0===e.denyallow&&void 0!==e.domains},{description:"Group simple patterns, into a single filter",fusion:e=>{const t=[];for(const s of e)s.isRegex()?t.push(`(?:${s.getRegex().source})`):s.isRightAnchor()?t.push(`${le(s.getFilter())}$`):s.isLeftAnchor()?t.push(`^${le(s.getFilter())}`):t.push(le(s.getFilter()));return new Mt(Object.assign({},e[0],{mask:Ge$1(e[0].mask,8388608),rawLine:void 0!==e[0].rawLine?e.map((({rawLine:e})=>e)).join(" <+> "):void 0,regex:new RegExp(t.join("|"))}))},groupByCriteria:e=>""+(-8388609&e.getMask()&-4194305),select:e=>void 0===e.domains&&void 0===e.denyallow&&!e.isHostnameAnchor()&&!e.isRedirect()&&!e.isCSP()}];function ue(e){return e}function pe(e){return e}function fe(e){const t=[];let s=e;for(const{select:e,fusion:i,groupByCriteria:r}of de){const{positive:n,negative:o}=he(s,e);s=o;const l=ce(n,r);for(const e of l)e.length>1?t.push(i(e)):s.push(e[0]);}for(const e of s)t.push(e);return t}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function ge(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}let me=1;const be=Number.MAX_SAFE_INTEGER>>>0;class ye{static deserialize(e,t,s,i){const r=e.getUint32(),n=e.getUint32(),o=e.getUint32(),l=Q$1.fromUint8Array(e.getBytes(!0),i),a=l.getUint32ArrayView(r),c=l.getUint32ArrayView(n),h=l.pos;return l.seekZero(),new ye({config:i,deserialize:t,filters:[],optimize:s}).updateInternals({bucketsIndex:c,filtersIndexStart:h,numberOfFilters:o,tokensLookupIndex:a,view:l})}constructor({deserialize:e,filters:t,optimize:s,config:i}){this.bucketsIndex=U,this.filtersIndexStart=0,this.numberOfFilters=0,this.tokensLookupIndex=U,this.cache=new Map,this.view=Q$1.empty(i),this.deserializeFilter=e,this.optimize=s,this.config=i,0!==t.length&&this.update(t,void 0);}getFilters(){const e=[];if(0===this.numberOfFilters)return e;this.view.setPos(this.filtersIndexStart);for(let t=0;t<this.numberOfFilters;t+=1)e.push(this.deserializeFilter(this.view));return this.view.seekZero(),e}getTokens(){const e=new Set;for(let t=0;t<this.bucketsIndex.length;t+=2)e.add(this.bucketsIndex[t]);return new Uint32Array(e)}getSerializedSize(){return 12+q$1(this.view.buffer,!0)}serialize(e){e.pushUint32(this.tokensLookupIndex.length),e.pushUint32(this.bucketsIndex.length),e.pushUint32(this.numberOfFilters),e.pushBytes(this.view.buffer,!0);}iterMatchingFilters(e,t){const s=function(){const e=me;return me=(me+1)%1e9,e}();for(const i of e)if(!1===this.iterBucket(i,s,t))return;this.iterBucket(0,s,t);}update(e,t){0!==this.cache.size&&this.cache.clear();const s=this.config.enableCompression;let i=0,r=0;const n=[];let o=0,l=this.view.buffer.byteLength-this.filtersIndexStart,a=this.getFilters();if(0!==a.length){void 0!==t&&0!==t.size&&(a=a.filter((e=>!t.has(e.getId())||(l-=e.getSerializedSize(s),!1))));for(const t of e)l+=t.getSerializedSize(s),a.push(t);}else {a=e;for(const t of e)l+=t.getSerializedSize(s);}if(0===a.length)return void this.updateInternals({bucketsIndex:U,filtersIndexStart:0,numberOfFilters:0,tokensLookupIndex:U,view:Q$1.empty(this.config)});!0===this.config.debug&&a.sort(((e,t)=>e.getId()-t.getId()));const c=new Uint32Array(Math.max(ge(2*a.length),256));for(const e of a){const t=e.getTokens();n.push(t),o+=2*t.length,r+=t.length;for(const e of t){i+=e.length;for(const t of e)c[t%c.length]+=1;}}l+=4*o;const h=Math.max(2,ge(r)),p=h-1,f=[];for(let e=0;e<h;e+=1)f.push([]);l+=4*h;const g=Q$1.allocate(l,this.config),m=g.getUint32ArrayView(h),b=g.getUint32ArrayView(o),y=g.getPos();for(let e=0;e<n.length;e+=1){const t=a[e],s=n[e],r=g.pos;t.serialize(g);for(const e of s){let t=0,s=i+1;for(const i of e){const e=c[i%c.length];if(e<s&&(s=e,t=i,1===s))break}f[t&p].push([t,r]);}}let I=0;for(let e=0;e<h;e+=1){const t=f[e];m[e]=I;for(const[e,s]of t)b[I++]=e,b[I++]=s;}g.seekZero(),this.updateInternals({bucketsIndex:b,filtersIndexStart:y,numberOfFilters:n.length,tokensLookupIndex:m,view:g});}updateInternals({bucketsIndex:e,filtersIndexStart:t,numberOfFilters:s,tokensLookupIndex:i,view:r}){return this.bucketsIndex=e,this.filtersIndexStart=t,this.numberOfFilters=s,this.tokensLookupIndex=i,this.view=r,r.seekZero(),this}iterBucket(e,t,s){let i=!0===this.config.enableInMemoryCache?this.cache.get(e):void 0;if(void 0===i){const t=e&this.tokensLookupIndex.length-1,s=this.tokensLookupIndex[t];if(s===be)return !0;const r=t===this.tokensLookupIndex.length-1?this.bucketsIndex.length:this.tokensLookupIndex[t+1],n=[];for(let t=s;t<r;t+=2){this.bucketsIndex[t]===e&&n.push(this.bucketsIndex[t+1]);}if(0===n.length)return !0;const o=[],l=this.view;for(let e=0;e<n.length;e+=1)l.setPos(n[e]),o.push(this.deserializeFilter(l));i={filters:o.length>1?this.optimize(o):o,lastRequestSeen:-1},!0===this.config.enableInMemoryCache&&this.cache.set(e,i);}if(i.lastRequestSeen!==t){i.lastRequestSeen=t;const e=i.filters;for(let t=0;t<e.length;t+=1)if(!1===s(e[t])){if(t>0){const s=e[t];e[t]=e[t-1],e[t-1]=s;}return !1}}return !0}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */const Ie=new Uint8Array(4);class ze{static deserialize(e,t,s){const i=new ze({deserialize:t,config:s,filters:[]});return i.filters=e.getBytes(),i}constructor({config:e,deserialize:t,filters:s}){this.deserialize=t,this.filters=Ie,this.config=e,0!==s.length&&this.update(s,void 0);}update(e,t){let s=this.filters.byteLength,i=[];const r=this.config.enableCompression,n=this.getFilters();if(0!==n.length)if(void 0===t||0===t.size)i=n;else for(const e of n)!1===t.has(e.getId())?i.push(e):s-=e.getSerializedSize(r);const o=i.length!==n.length,l=i.length;for(const t of e)s+=t.getSerializedSize(r),i.push(t);const a=i.length>l;if(0===i.length)this.filters=Ie;else if(!0===a||!0===o){const e=Q$1.allocate(s,this.config);e.pushUint32(i.length),!0===this.config.debug&&i.sort(((e,t)=>e.getId()-t.getId()));for(const t of i)t.serialize(e);this.filters=e.buffer;}}getSerializedSize(){return q$1(this.filters,!1)}serialize(e){e.pushBytes(this.filters);}getFilters(){if(this.filters.byteLength<=4)return [];const e=[],t=Q$1.fromUint8Array(this.filters,this.config),s=t.getUint32();for(let i=0;i<s;i+=1)e.push(this.deserialize(t));return e}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function xe(e,t){if(0===e.length)return "";const s=1024,i=[],r=` { ${t} }`;for(let t=0;t<e.length;t+=s){let n=e[t];for(let i=t+1,r=Math.min(e.length,t+s);i<r;i+=1)n+=",\n"+e[i];if(n+=r,e.length<s)return n;i.push(n);}return i.join("\n")}function ve(e){const t=new Map;for(const s of e){const e=s.getStyle(),i=t.get(e);void 0===i?t.set(e,[s.getSelector()]):i.push(s.getSelector());}const s=[],i=Array.from(t.entries());for(const[e,t]of i)s.push(xe(t,e));return s.join("\n\n")}function Fe(e){const t=[];for(const s of e){if(s.hasCustomStyle())return ve(e);t.push(s.selector);}return xe(t,vt)}function we(e,t){const s=dt(e,t),i=ft(e,t),r=new Uint32Array(s.length+i.length);let n=0;for(const e of s)r[n++]=e;for(const e of i)r[n++]=e;return r}class Se{static deserialize(e,t){const s=new Se({config:t});return s.genericRules=ze.deserialize(e,It.deserialize,t),s.classesIndex=ye.deserialize(e,It.deserialize,pe,t),s.hostnameIndex=ye.deserialize(e,It.deserialize,pe,t),s.hrefsIndex=ye.deserialize(e,It.deserialize,pe,t),s.htmlIndex=ye.deserialize(e,It.deserialize,pe,t),s.idsIndex=ye.deserialize(e,It.deserialize,pe,t),s.unhideIndex=ye.deserialize(e,It.deserialize,pe,t),s}constructor({filters:e=[],config:t}){this.genericRules=new ze({config:t,deserialize:It.deserialize,filters:[]}),this.classesIndex=new ye({config:t,deserialize:It.deserialize,filters:[],optimize:pe}),this.hostnameIndex=new ye({config:t,deserialize:It.deserialize,filters:[],optimize:pe}),this.hrefsIndex=new ye({config:t,deserialize:It.deserialize,filters:[],optimize:pe}),this.htmlIndex=new ye({config:t,deserialize:It.deserialize,filters:[],optimize:pe}),this.idsIndex=new ye({config:t,deserialize:It.deserialize,filters:[],optimize:pe}),this.unhideIndex=new ye({config:t,deserialize:It.deserialize,filters:[],optimize:pe}),this.baseStylesheet=null,this.extraGenericRules=null,0!==e.length&&this.update(e,void 0,t);}getFilters(){return [].concat(this.genericRules.getFilters(),this.classesIndex.getFilters(),this.hostnameIndex.getFilters(),this.hrefsIndex.getFilters(),this.htmlIndex.getFilters(),this.idsIndex.getFilters(),this.unhideIndex.getFilters())}update(e,t,s){const i=[],r=[],n=[],o=[],l=[],a=[],c=[];for(const t of e)t.isUnhide()?c.push(t):t.isHtmlFiltering()?l.push(t):t.isGenericHide()?t.isClassSelector()?i.push(t):t.isIdSelector()?a.push(t):t.isHrefSelector()?o.push(t):r.push(t):!1!==t.isExtended()&&!0!==s.loadExtendedSelectors||n.push(t);this.genericRules.update(r,t),this.classesIndex.update(i,t),this.hostnameIndex.update(n,t),this.hrefsIndex.update(o,t),this.htmlIndex.update(l,t),this.idsIndex.update(a,t),this.unhideIndex.update(c,t);}getSerializedSize(){return this.genericRules.getSerializedSize()+this.classesIndex.getSerializedSize()+this.hostnameIndex.getSerializedSize()+this.hrefsIndex.getSerializedSize()+this.htmlIndex.getSerializedSize()+this.idsIndex.getSerializedSize()+this.unhideIndex.getSerializedSize()}serialize(e){this.genericRules.serialize(e),this.classesIndex.serialize(e),this.hostnameIndex.serialize(e),this.hrefsIndex.serialize(e),this.htmlIndex.serialize(e),this.idsIndex.serialize(e),this.unhideIndex.serialize(e);}getHtmlRules({domain:e,hostname:t,isFilterExcluded:s}){const i=we(t,e),r=[];this.htmlIndex.iterMatchingFilters(i,(i=>(i.match(t,e)&&!(null==s?void 0:s(i))&&r.push(i),!0)));const n=new Set;return 0!==r.length&&this.unhideIndex.iterMatchingFilters(i,(i=>(i.match(t,e)&&!(null==s?void 0:s(i))&&n.add(i.getSelector()),!0))),r.filter((e=>0===n.size||!1===n.has(e.getSelector())))}getCosmeticsFilters({domain:e,hostname:t,classes:s=[],hrefs:i=[],ids:r=[],allowGenericHides:n=!0,allowSpecificHides:o=!0,getBaseRules:l=!0,getInjectionRules:a=!0,getExtendedRules:c=!0,getRulesFromDOM:h=!0,getRulesFromHostname:d=!0,isFilterExcluded:u}){const p=we(t,e),m=[];if(!0===d&&this.hostnameIndex.iterMatchingFilters(p,(s=>(!0!==o&&!0!==s.isScriptInject()||!s.match(t,e)||(null==u?void 0:u(s))||m.push(s),!0))),!0===n&&!0===d){const s=this.getGenericRules();for(const i of s)!0!==i.match(t,e)||(null==u?void 0:u(i))||m.push(i);}!0===n&&!0===h&&0!==s.length&&this.classesIndex.iterMatchingFilters(Ke$1(s),(s=>(s.match(t,e)&&!(null==u?void 0:u(s))&&m.push(s),!0))),!0===n&&!0===h&&0!==r.length&&this.idsIndex.iterMatchingFilters(Ke$1(r),(s=>(s.match(t,e)&&!(null==u?void 0:u(s))&&m.push(s),!0))),!0===n&&!0===h&&0!==i.length&&this.hrefsIndex.iterMatchingFilters(function(e){const t=e.sort();let s=1;for(let e=1;e<t.length;e+=1)t[s-1]!==t[e]&&(t[s++]=t[e]);return t.subarray(0,s)}(function(e){if(0===e.length)return oe;if(1===e.length)return e[0];let t=0;for(let s=0;s<e.length;s+=1)t+=e[s].length;const s=new Uint32Array(t);let i=0;for(let t=0;t<e.length;t+=1){const r=e[t];for(let e=0;e<r.length;e+=1)s[i++]=r[e];}return s}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */(i.map((e=>it$1(e))))),(s=>(s.match(t,e)&&!(null==u?void 0:u(s))&&m.push(s),!0)));const b=[],y=[],I=[];if(0!==m.length){let s=!1;const i=new Set;this.unhideIndex.iterMatchingFilters(p,(r=>(r.match(t,e)&&!(null==u?void 0:u(r))&&(i.add(r.getSelector()),!0===r.isScriptInject()&&!0===r.isUnhide()&&0===r.getSelector().length&&(s=!0)),!0)));for(const e of m)0!==i.size&&i.has(e.getSelector())||(!0===e.isScriptInject()?!0===a&&!1===s&&y.push(e):e.isExtended()?!0===c&&b.push(e):I.push(e));}let z=!1===l||!1===n?"":this.getBaseStylesheet();0!==I.length&&(0!==z.length&&(z+="\n\n"),z+=Fe(I));const x=[];if(0!==b.length){const e=new Map;for(const t of b){const s=t.getSelectorAST();if(void 0!==s){const i=t.isRemove()?void 0:t.getStyleAttributeHash();void 0!==i&&e.set(t.getStyle(),i),x.push({ast:s,remove:t.isRemove(),attribute:i});}}0!==e.size&&(0!==z.length&&(z+="\n\n"),z+=[...e.entries()].map((([e,t])=>`[${t}] { ${e} }`)).join("\n\n"));}return {extended:x,injections:y,stylesheet:z}}getGenericRules(){return null===this.extraGenericRules?this.lazyPopulateGenericRulesCache().genericRules:this.extraGenericRules}getBaseStylesheet(){return null===this.baseStylesheet?this.lazyPopulateGenericRulesCache().baseStylesheet:this.baseStylesheet}lazyPopulateGenericRulesCache(){if(null===this.baseStylesheet||null===this.extraGenericRules){const e=this.unhideIndex.getFilters(),t=new Set;for(const s of e)t.add(s.getSelector());const s=this.genericRules.getFilters(),i=[],r=[];for(const e of s)e.hasCustomStyle()||e.isScriptInject()||e.hasHostnameConstraint()||t.has(e.getSelector())?r.push(e):i.push(e);this.baseStylesheet=Fe(i),this.extraGenericRules=r;}return {baseStylesheet:this.baseStylesheet,genericRules:this.extraGenericRules}}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class ke{static deserialize(e,t){const i=new ke({config:t});return i.index=ye.deserialize(e,Mt.deserialize,t.enableOptimizations?fe:ue,t),i.badFilters=ze.deserialize(e,Mt.deserialize,t),i}constructor({filters:e=[],config:t}){this.index=new ye({config:t,deserialize:Mt.deserialize,filters:[],optimize:t.enableOptimizations?fe:ue}),this.badFiltersIds=null,this.badFilters=new ze({config:t,deserialize:Mt.deserialize,filters:[]}),0!==e.length&&this.update(e,void 0);}getFilters(){return [].concat(this.badFilters.getFilters(),this.index.getFilters())}update(e,t){const s=[],i=[];for(const t of e)t.isBadFilter()?s.push(t):i.push(t);this.badFilters.update(s,t),this.index.update(i,t),this.badFiltersIds=null;}getSerializedSize(){return this.badFilters.getSerializedSize()+this.index.getSerializedSize()}serialize(e){this.index.serialize(e),this.badFilters.serialize(e);}matchAll(e,t){const s=[];return this.index.iterMatchingFilters(e.getTokens(),(i=>(i.match(e)&&!1===this.isFilterDisabled(i)&&!(null==t?void 0:t(i))&&s.push(i),!0))),s}match(e,t){let s;return this.index.iterMatchingFilters(e.getTokens(),(i=>!(i.match(e)&&!1===this.isFilterDisabled(i)&&!(null==t?void 0:t(i)))||(s=i,!1))),s}isFilterDisabled(e){if(null===this.badFiltersIds){const e=this.badFilters.getFilters();if(0===e.length)return !1;const t=new Set;for(const s of e)t.add(s.getIdWithoutBadFilter());this.badFiltersIds=t;}return this.badFiltersIds.has(e.getId())}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */const Ee=Number.MAX_SAFE_INTEGER>>>0;class Ce{static deserialize(e,t){const s=e.getUint32(),i=e.getUint32(),r=e.getUint32(),n=Q$1.fromUint8Array(e.getBytes(!0),{enableCompression:!1}),o=n.getUint32ArrayView(s),l=n.getUint32ArrayView(i),a=n.pos;return n.seekZero(),new Ce({deserialize:t,values:[],getKeys:()=>[],getSerializedSize:()=>0,serialize:()=>{}}).updateInternals({bucketsIndex:l,valuesIndexStart:a,numberOfValues:r,tokensLookupIndex:o,view:n})}constructor({serialize:e,deserialize:t,getKeys:s,getSerializedSize:i,values:r}){if(this.cache=new Map,this.bucketsIndex=U,this.tokensLookupIndex=U,this.valuesIndexStart=0,this.numberOfValues=0,this.view=Q$1.empty({enableCompression:!1}),this.deserializeValue=t,0!==r.length){const t=[];let n=0,o=0;for(const e of r)o+=i(e);if(0===r.length)return void this.updateInternals({bucketsIndex:U,valuesIndexStart:0,numberOfValues:0,tokensLookupIndex:U,view:Q$1.empty({enableCompression:!1})});for(const e of r){const i=s(e);t.push(i),n+=2*i.length;}o+=4*n;const l=Math.max(2,ge(r.length)),a=l-1,c=[];for(let e=0;e<l;e+=1)c.push([]);o+=4*l;const h=Q$1.allocate(o,{enableCompression:!1}),p=h.getUint32ArrayView(l),f=h.getUint32ArrayView(n),g=h.getPos();for(let s=0;s<t.length;s+=1){const i=r[s],n=t[s],o=h.pos;e(i,h);for(const e of n)c[e&a].push([e,o]);}let m=0;for(let e=0;e<l;e+=1){const t=c[e];p[e]=m;for(const[e,s]of t)f[m++]=e,f[m++]=s;}this.updateInternals({bucketsIndex:f,valuesIndexStart:g,numberOfValues:t.length,tokensLookupIndex:p,view:h});}}updateInternals({bucketsIndex:e,valuesIndexStart:t,numberOfValues:s,tokensLookupIndex:i,view:r}){return this.bucketsIndex=e,this.valuesIndexStart=t,this.numberOfValues=s,this.tokensLookupIndex=i,this.view=r,r.seekZero(),this}getValues(){const e=[];if(0===this.numberOfValues)return e;this.view.setPos(this.valuesIndexStart);for(let t=0;t<this.numberOfValues;t+=1)e.push(this.deserializeValue(this.view));return this.view.seekZero(),e}getSerializedSize(){return 12+q$1(this.view.buffer,!0)}serialize(e){e.pushUint32(this.tokensLookupIndex.length),e.pushUint32(this.bucketsIndex.length),e.pushUint32(this.numberOfValues),e.pushBytes(this.view.buffer,!0);}get(e){const t=this.cache.get(e);if(void 0!==t)return t;const s=e&this.tokensLookupIndex.length-1,i=this.tokensLookupIndex[s];if(i===Ee)return [];const r=s===this.tokensLookupIndex.length-1?this.bucketsIndex.length:this.tokensLookupIndex[s+1],n=[];for(let t=i;t<r;t+=2){this.bucketsIndex[t]===e&&n.push(this.bucketsIndex[t+1]);}if(0===n.length)return [];const o=[],l=this.view;for(let e=0;e<n.length;e+=1)l.setPos(n[e]),o.push(this.deserializeValue(l));return this.cache.set(e,o),o}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function Ae(e){if(null===e)return !1;if("object"!=typeof e)return !1;const{key:t,name:s,color:i,description:r}=e;return "string"==typeof t&&("string"==typeof s&&("string"==typeof i&&"string"==typeof r))}function Ue(e){return Xe$1(e.key)}function Te(e){return G$1(e.key)+G$1(e.name)+G$1(e.color)+G$1(e.description)}function Re(e,t){t.pushUTF8(e.key),t.pushUTF8(e.name),t.pushUTF8(e.color),t.pushUTF8(e.description);}function Be(e){return {key:e.getUTF8(),name:e.getUTF8(),color:e.getUTF8(),description:e.getUTF8()}}function Le(e){return new Ce({getSerializedSize:Te,getKeys:e=>[Ue(e)],serialize:Re,deserialize:Be,values:e})}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function De(e){if(null===e)return !1;if("object"!=typeof e)return !1;const{key:t,name:s,description:i,country:r,website_url:n,privacy_policy_url:o,privacy_contact:l,ghostery_id:a}=e;return "string"==typeof t&&("string"==typeof s&&((null===i||"string"==typeof i)&&((null===r||"string"==typeof r)&&((null===n||"string"==typeof n)&&((null===o||"string"==typeof o)&&((null===l||"string"==typeof l)&&(null===a||"string"==typeof a)))))))}function Oe(e){return Xe$1(e.key)}function Pe(e){return G$1(e.key)+G$1(e.name)+G$1(e.description||"")+G$1(e.website_url||"")+G$1(e.country||"")+G$1(e.privacy_policy_url||"")+G$1(e.privacy_contact||"")+G$1(e.ghostery_id||"")}function Ne(e,t){t.pushUTF8(e.key),t.pushUTF8(e.name),t.pushUTF8(e.description||""),t.pushUTF8(e.website_url||""),t.pushUTF8(e.country||""),t.pushUTF8(e.privacy_policy_url||""),t.pushUTF8(e.privacy_contact||""),t.pushUTF8(e.ghostery_id||"");}function _e(e){return {key:e.getUTF8(),name:e.getUTF8(),description:e.getUTF8()||null,website_url:e.getUTF8()||null,country:e.getUTF8()||null,privacy_policy_url:e.getUTF8()||null,privacy_contact:e.getUTF8()||null,ghostery_id:e.getUTF8()||null}}function je(e){return new Ce({getSerializedSize:Pe,getKeys:e=>[Oe(e)],serialize:Ne,deserialize:_e,values:e})}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function Me(e){if(null===e)return !1;if("object"!=typeof e)return !1;const{key:t,name:s,category:i,organization:r,alias:n,website_url:o,domains:l,filters:a}=e;return "string"==typeof t&&("string"==typeof s&&("string"==typeof i&&((null===r||"string"==typeof r)&&(("string"==typeof n||null===n)&&((null===o||"string"==typeof o)&&(!(!Array.isArray(l)||!l.every((e=>"string"==typeof e)))&&!(!Array.isArray(a)||!a.every((e=>"string"==typeof e)))))))))}function Ge(e){const t=[];for(const i of e.filters){const e=Mt.parse(i);null!==e&&t.push(e.getId());}for(const i of e.domains){const e=Mt.parse(`||${i}^`);null!==e&&t.push(e.getId());}return [...new Set(t)]}function $e(e){let s=z(e.domains.length);for(const i of e.domains)s+=G$1(i);let i=z(e.filters.length);for(const s of e.filters)i+=G$1(s);return G$1(e.key)+G$1(e.name)+G$1(e.category)+G$1(e.organization||"")+G$1(e.alias||"")+G$1(e.website_url||"")+G$1(e.ghostery_id||"")+s+i}function He(e,t){t.pushUTF8(e.key),t.pushUTF8(e.name),t.pushUTF8(e.category),t.pushUTF8(e.organization||""),t.pushUTF8(e.alias||""),t.pushUTF8(e.website_url||""),t.pushUTF8(e.ghostery_id||""),t.pushLength(e.domains.length);for(const s of e.domains)t.pushUTF8(s);t.pushLength(e.filters.length);for(const s of e.filters)t.pushUTF8(s);}function qe(e){const t=e.getUTF8(),s=e.getUTF8(),i=e.getUTF8(),r=e.getUTF8()||null,n=e.getUTF8()||null,o=e.getUTF8()||null,l=e.getUTF8()||null,a=e.getLength(),c=[];for(let t=0;t<a;t+=1)c.push(e.getUTF8());const h=e.getLength(),d=[];for(let t=0;t<h;t+=1)d.push(e.getUTF8());return {key:t,name:s,category:i,organization:r,alias:n,website_url:o,ghostery_id:l,domains:c,filters:d}}function Ve(e){return new Ce({getSerializedSize:$e,getKeys:Ge,serialize:He,deserialize:qe,values:e})}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class We{static deserialize(e){const t=new We(null);return t.categories=Ce.deserialize(e,Be),t.organizations=Ce.deserialize(e,_e),t.patterns=Ce.deserialize(e,qe),t}constructor(e){if(!e)return this.organizations=je([]),this.categories=Le([]),void(this.patterns=Ve([]));const{patterns:t,organizations:s,categories:i}=e,r=[];if("object"==typeof i)for(const[e,t]of Object.entries(i)){if("object"!=typeof t)continue;const s=Object.assign({key:e},t);Ae(s)?r.push(s):console.error("?? invalid category",s);}this.categories=Le(r);const n=[];if("object"==typeof s)for(const[e,t]of Object.entries(s)){if("object"!=typeof t)continue;const s=Object.assign({key:e},t);De(s)?n.push(s):console.error("?? invalid organization",s);}this.organizations=je(n);const o=[];if("object"==typeof t)for(const[e,s]of Object.entries(t)){if("object"!=typeof s)continue;const t=Object.assign({key:e},s);Me(t)?o.push(t):console.error("?? invalid pattern",t);}this.patterns=Ve(o);}getCategories(){return this.categories.getValues()}getOrganizations(){return this.organizations.getValues()}getPatterns(){return this.patterns.getValues()}getSerializedSize(){return this.categories.getSerializedSize()+this.organizations.getSerializedSize()+this.patterns.getSerializedSize()}serialize(e){this.categories.serialize(e),this.organizations.serialize(e),this.patterns.serialize(e);}fromFilter(e){return this.fromId(e.getId())}fromDomain(e){const t=e.split(".");for(;t.length>=2;t.shift()){const e=t.join("."),i=Mt.parse(`||${e}^`);if(null===i)continue;const r=this.fromId(i.getId());if(r.length>0)return r}return []}fromId(e){var t,s;const i=[];for(const r of this.patterns.get(e))i.push({pattern:r,category:null===(t=this.categories.get(Ue({key:r.category})))||void 0===t?void 0:t[0],organization:null!==r.organization?null===(s=this.organizations.get(Oe({key:r.organization})))||void 0===s?void 0:s[0]:null});return i}}class Ke{static deserialize(e){const t=new Set;for(let s=0,i=e.getUint32();s<i;s++)t.add(e.getUint32());const s=[];for(let t=0,i=e.getUint32();t<i;t++)s.push(se.deserialize(e));return new this({excluded:t,preprocessors:s})}constructor({excluded:e=new Set,preprocessors:t=[]}){this.excluded=e,this.preprocessors=t;}isFilterExcluded(e){return this.excluded.has(e.getId())}updateEnv(e){this.excluded.clear();for(const t of this.preprocessors)if(!t.evaluate(e))for(const e of t.filterIDs)this.excluded.add(e);}update({added:e,removed:t},s){if(t)for(const e of t){const t=this.preprocessors.find((t=>t.condition===e.condition));if(t)for(const s of e.filterIDs)t.filterIDs.delete(s);}if(e)for(const t of e){const e=this.preprocessors.find((e=>e.condition===t.condition));if(e)for(const s of t.filterIDs)e.filterIDs.add(s);else this.preprocessors.push(t);}(t&&0!==t.length||e&&0!==e.length)&&this.updateEnv(s);}serialize(e){e.pushUint32(this.excluded.size);for(const t of this.excluded)e.pushUint32(t);e.pushUint32(this.preprocessors.length);for(const t of this.preprocessors)t.serialize(e);}getSerializedSize(){let e=4*(1+this.excluded.size);e+=4;for(const t of this.preprocessors)e+=t.getSerializedSize();return e}}
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function Ze(e){if(0===e.length)return !1;let t,s=0;for(const i of e){const e=(i.isImportant()?4:0)|(i.isException()?1:2);e>=s&&(s=e,t=i);}return void 0!==t&&t.isException()}class Xe extends q{static fromCached(e,t){if(void 0===t)return e();const{path:s,read:i,write:r}=t;return i(s).then((e=>this.deserialize(e))).catch((()=>e().then((e=>r(s,e.serialize()).then((()=>e))))))}static empty(e={}){return new this({config:e})}static fromLists(e,t,s={},i){return this.fromCached((()=>{const i=te$1(e,t),r=ne$1(e);return Promise.all([i,r]).then((([e,t])=>{const i=this.parse(e.join("\n"),s);return void 0!==t&&i.updateResources(t,""+t.length),i}))}),i)}static fromPrebuiltAdsOnly(e=fetch,t){return this.fromLists(e,Z$1,{},t)}static fromPrebuiltAdsAndTracking(e=fetch,t){return this.fromLists(e,J$1,{},t)}static fromPrebuiltFull(e=fetch,t){return this.fromLists(e,ee$1,{},t)}static fromTrackerDB(e,t={}){const s=new _(t),i=new We(e),r=[];for(const e of i.getPatterns())r.push(...e.filters);const n=this.parse(r.join("\n"),s);return n.metadata=i,n}static parse(e,t={}){const s=new _(t);return new this(Object.assign(Object.assign({},re(e,s)),{config:s}))}static deserialize(e){const t=Q$1.fromUint8Array(e,{enableCompression:!1}),s=t.getUint16();if(654!==s)throw new Error(`serialized engine version mismatch, expected 654 but got ${s}`);const i=_.deserialize(t);if(i.enableCompression&&t.enableCompression(),i.integrityCheck){const s=t.pos;t.pos=e.length-4;const i=t.checksum(),r=t.getUint32();if(i!==r)throw new Error(`serialized engine checksum mismatch, expected ${r} but got ${i}`);t.pos=s;}const r=new this({config:i});r.resources=ne.deserialize(t);const n=new Map,o=t.getUint16();for(let e=0;e<o;e+=1)n.set(t.getASCII(),t.getASCII());r.lists=n,r.preprocessors=Ke.deserialize(t),r.importants=ke.deserialize(t,i),r.redirects=ke.deserialize(t,i),r.filters=ke.deserialize(t,i),r.exceptions=ke.deserialize(t,i),r.csp=ke.deserialize(t,i),r.cosmetics=Se.deserialize(t,i),r.hideExceptions=ke.deserialize(t,i);return t.getBool()&&(r.metadata=We.deserialize(t)),t.seekZero(),r}constructor({cosmeticFilters:e=[],networkFilters:t=[],preprocessors:s=[],config:i=new _,lists:r=new Map}={}){super(),this.config=new _(i),this.lists=r,this.preprocessors=new Ke({}),this.csp=new ke({config:this.config}),this.hideExceptions=new ke({config:this.config}),this.exceptions=new ke({config:this.config}),this.importants=new ke({config:this.config}),this.redirects=new ke({config:this.config}),this.filters=new ke({config:this.config}),this.cosmetics=new Se({config:this.config}),this.resources=new ne,0===t.length&&0===e.length||this.update({newCosmeticFilters:e,newNetworkFilters:t,newPreprocessors:s});}isFilterExcluded(e){return this.preprocessors.isFilterExcluded(e)}updateEnv(e){this.preprocessors.updateEnv(e);}getSerializedSize(){let t=H$1()+this.config.getSerializedSize()+this.resources.getSerializedSize()+this.preprocessors.getSerializedSize()+this.filters.getSerializedSize()+this.exceptions.getSerializedSize()+this.importants.getSerializedSize()+this.redirects.getSerializedSize()+this.csp.getSerializedSize()+this.cosmetics.getSerializedSize()+this.hideExceptions.getSerializedSize()+4;for(const[e,s]of this.lists)t+=V$1(e)+V$1(s);return t+=O(),void 0!==this.metadata&&(t+=this.metadata.getSerializedSize()),t}serialize(e){const t=Q$1.fromUint8Array(e||new Uint8Array(this.getSerializedSize()),this.config);t.pushUint16(654),this.config.serialize(t),this.resources.serialize(t),t.pushUint16(this.lists.size);for(const[e,s]of Array.from(this.lists.entries()).sort())t.pushASCII(e),t.pushASCII(s);return this.preprocessors.serialize(t),this.importants.serialize(t),this.redirects.serialize(t),this.filters.serialize(t),this.exceptions.serialize(t),this.csp.serialize(t),this.cosmetics.serialize(t),this.hideExceptions.serialize(t),t.pushBool(void 0!==this.metadata),void 0!==this.metadata&&this.metadata.serialize(t),this.config.integrityCheck&&t.pushUint32(t.checksum()),t.subarray()}loadedLists(){return Array.from(this.lists.keys())}hasList(e,t){return this.lists.has(e)&&this.lists.get(e)===t}updateResources(e,t){return this.resources.checksum!==t&&(this.resources=ne.parse(e,{checksum:t}),!0)}getFilters(){return {cosmeticFilters:[].concat(this.cosmetics.getFilters()),networkFilters:[].concat(this.filters.getFilters(),this.exceptions.getFilters(),this.importants.getFilters(),this.redirects.getFilters(),this.csp.getFilters(),this.hideExceptions.getFilters())}}update({newNetworkFilters:e=[],newCosmeticFilters:t=[],newPreprocessors:s=[],removedCosmeticFilters:i=[],removedNetworkFilters:r=[],removedPreprocessors:n=[]},o=new K){let l=!1;if(!this.config.loadPreprocessors||0===s.length&&0===n.length||(l=!0,this.preprocessors.update({added:s,removed:n},o)),!this.config.loadCosmeticFilters||0===t.length&&0===i.length||(l=!0,this.cosmetics.update(t,0===i.length?void 0:new Set(i),this.config)),this.config.loadNetworkFilters&&(0!==e.length||0!==r.length)){l=!0;const t=[],s=[],i=[],n=[],o=[],a=[];for(const r of e)r.isCSP()?s.push(r):r.isGenericHide()||r.isSpecificHide()?a.push(r):r.isException()?i.push(r):r.isImportant()?n.push(r):r.isRedirect()?o.push(r):t.push(r);const c=0===r.length?void 0:new Set(r);this.importants.update(n,c),this.redirects.update(o,c),this.filters.update(t,c),!0===this.config.loadExceptionFilters&&this.exceptions.update(i,c),!0===this.config.loadCSPFilters&&this.csp.update(s,c),this.hideExceptions.update(a,c);}return l}updateFromDiff({added:e,removed:t,preprocessors:s},i){const r=[],n=[],o=[],l=[],a=[],c=[];if(void 0!==t&&0!==t.length){const{networkFilters:e,cosmeticFilters:s}=re(t.join("\n"),this.config);Array.prototype.push.apply(l,s),Array.prototype.push.apply(a,e);}if(void 0!==e&&0!==e.length){const{networkFilters:t,cosmeticFilters:s}=re(e.join("\n"),this.config);Array.prototype.push.apply(r,s),Array.prototype.push.apply(n,t);}if(void 0!==s)for(const[e,t]of Object.entries(s)){if(void 0!==t.removed&&0!==t.removed.length){const{networkFilters:s,cosmeticFilters:i}=re(t.removed.join("\n"),this.config),r=new Set([].concat(i.map((e=>e.getId()))).concat(s.map((e=>e.getId()))));Array.prototype.push.apply(l,i),Array.prototype.push.apply(a,s),c.push(new se({condition:e,filterIDs:r}));}if(void 0!==t.added&&0!==t.added.length){const{networkFilters:s,cosmeticFilters:i}=re(t.added.join("\n"),this.config),l=new Set([].concat(i.map((e=>e.getId()))).concat(s.map((e=>e.getId()))));Array.prototype.push.apply(r,i),Array.prototype.push.apply(n,s),o.push(new se({condition:e,filterIDs:l}));}}return this.update({newCosmeticFilters:r,newNetworkFilters:n,newPreprocessors:o,removedCosmeticFilters:l.map((e=>e.getId())),removedNetworkFilters:a.map((e=>e.getId())),removedPreprocessors:c},i)}getHtmlFilters({url:e,hostname:t,domain:s}){const i=[];if(!1===this.config.enableHtmlFiltering||!1===this.config.loadCosmeticFilters)return i;const r=this.cosmetics.getHtmlRules({domain:s||"",hostname:t,isFilterExcluded:this.isFilterExcluded.bind(this)});for(const e of r){const t=e.getExtendedSelector();void 0!==t&&i.push(t);}return 0!==i.length&&this.emit("html-filtered",i,e),i}getCosmeticsFilters({url:e,hostname:t,domain:s,classes:i,hrefs:r,ids:n,getBaseRules:o=!0,getInjectionRules:l=!0,getExtendedRules:a=!0,getRulesFromDOM:c=!0,getRulesFromHostname:h=!0}){if(!1===this.config.loadCosmeticFilters)return {active:!1,extended:[],scripts:[],styles:""};let d=!0,u=!0;const p=this.hideExceptions.matchAll(ht.fromRawDetails({domain:s||"",hostname:t,url:e,sourceDomain:"",sourceHostname:"",sourceUrl:""}),this.isFilterExcluded.bind(this)),f=[],g=[];for(const e of p){if(e.isElemHide()){d=!1,u=!1;break}e.isSpecificHide()?g.push(e):e.isGenericHide()&&f.push(e);}!0===d&&(d=!1===Ze(f)),!0===u&&(u=!1===Ze(g));const{injections:m,stylesheet:b,extended:y}=this.cosmetics.getCosmeticsFilters({domain:s||"",hostname:t,classes:i,hrefs:r,ids:n,allowGenericHides:d,allowSpecificHides:u,getBaseRules:o,getInjectionRules:l,getExtendedRules:a,getRulesFromDOM:c,getRulesFromHostname:h,isFilterExcluded:this.isFilterExcluded.bind(this)}),I=[];for(const t of m){const s=t.getScript(this.resources.js);void 0!==s&&(this.emit("script-injected",s,e),I.push(s));}return 0!==b.length&&this.emit("style-injected",b,e),{active:!0,extended:y,scripts:I,styles:b}}matchAll(e){const t=[];return e.isSupported&&(Array.prototype.push.apply(t,this.importants.matchAll(e,this.isFilterExcluded.bind(this))),Array.prototype.push.apply(t,this.filters.matchAll(e,this.isFilterExcluded.bind(this))),Array.prototype.push.apply(t,this.exceptions.matchAll(e,this.isFilterExcluded.bind(this))),Array.prototype.push.apply(t,this.csp.matchAll(e,this.isFilterExcluded.bind(this))),Array.prototype.push.apply(t,this.hideExceptions.matchAll(e,this.isFilterExcluded.bind(this))),Array.prototype.push.apply(t,this.redirects.matchAll(e,this.isFilterExcluded.bind(this)))),new Set(t)}getCSPDirectives(e){if(!this.config.loadNetworkFilters)return;if(!0!==e.isSupported||!1===e.isMainFrame())return;const t=this.csp.matchAll(e,this.isFilterExcluded.bind(this));if(0===t.length)return;const s=new Set,i=new Set;for(const e of t)if(e.isException()){if(void 0===e.csp)return;s.add(e.csp);}else i.add(e.csp);const r=Array.from(i).filter((e=>!s.has(e))).join("; ")||void 0;return void 0!==r&&this.emit("csp-injected",r,e),r}match(e,t=!1){const s={exception:void 0,filter:void 0,match:!1,redirect:void 0,metadata:void 0};if(!this.config.loadNetworkFilters)return s;if(e.isSupported){let t,i;if(s.filter=this.importants.match(e,this.isFilterExcluded.bind(this)),void 0===s.filter){const r=this.redirects.matchAll(e,this.isFilterExcluded.bind(this));if(0!==r.length)for(const e of r)"none"===e.getRedirect()?t=e:e.isRedirectRule()?i=e:s.filter=e;void 0===s.filter&&(s.filter=this.filters.match(e,this.isFilterExcluded.bind(this)),void 0!==i&&void 0!==s.filter&&(s.filter=i)),void 0!==s.filter&&(s.exception=this.exceptions.match(e,this.isFilterExcluded.bind(this)));}void 0!==s.filter&&void 0===s.exception&&s.filter.isRedirect()&&(void 0!==t?s.exception=t:s.redirect=this.resources.getResource(s.filter.getRedirect()));}return s.match=void 0===s.exception&&void 0!==s.filter,void 0!==s.exception?this.emit("request-whitelisted",e,s):void 0!==s.redirect?this.emit("request-redirected",e,s):void 0!==s.filter?this.emit("request-blocked",e,s):this.emit("request-allowed",e,s),!0===t&&void 0!==s.filter&&this.metadata&&(s.metadata=this.metadata.fromFilter(s.filter)),s}getPatternMetadata(e,{getDomainMetadata:t=!1}={}){if(void 0===this.metadata)return [];const s=new Set,i=[];for(const t of this.matchAll(e))for(const e of this.metadata.fromFilter(t))s.has(e.pattern.key)||(s.add(e.pattern.key),i.push(e));if(t)for(const t of this.metadata.fromDomain(e.hostname))s.has(t.pattern.key)||(s.add(t.pattern.key),i.push(t));return i}blockScripts(){return this.updateFromDiff({added:[W().scripts().redirectTo("javascript").toString()]}),this}blockImages(){return this.updateFromDiff({added:[W().images().redirectTo("png").toString()]}),this}blockMedias(){return this.updateFromDiff({added:[W().medias().redirectTo("mp4").toString()]}),this}blockFrames(){return this.updateFromDiff({added:[W().frames().redirectTo("html").toString()]}),this}blockFonts(){return this.updateFromDiff({added:[W().fonts().toString()]}),this}blockStyles(){return this.updateFromDiff({added:[W().styles().toString()]}),this}}class Qe extends Xe{static fromLists(e,t,s={},i){return this.fromCached((()=>{const i=te$1(e,t),r=this.fetchResources(e);return Promise.all([i,r]).then((([e,t])=>{const i=this.parse(e.join("\n"),s);return void 0!==t&&i.updateResources(t,""+t.length),i})).catch((e=>{console.log(e);}))}),i)}static fetchResources(e){var t="https://raw.githubusercontent.com/cliqz-oss/adblocker/master/packages/adblocker/assets/ublock-origin/resources.txt";return (navigator.languages.includes("zh-CN")||navigator.languages.includes("zh"))&&(t="https://res.appletuner.trendmicro.com/AdBlockOne/resources.txt"),this.fetchResource(e,t)}static fetchResource(e,t){return X$1(e,t).then((e=>e.text()))}enableBlocking(){this.enabled=!0,n.exports.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["ruleset_1","ruleset_2","ruleset_3","ruleset_4"]}),c.initUnblockedList(),this.setEngineEnabledLocal();}disableBlocking(){this.enabled=!1,n.exports.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["ruleset_1","ruleset_2","ruleset_3","ruleset_4"]}),this.setEngineEnabledLocal();}isBlockingEnabled(){return this.enabled}setEngineEnabledLocal(){let e={};e[this.engineName]=this.enabled,n.exports.storage.local.set(e);}setBlockingCallback(e){this.blockingCallback=e;}store2Local(e){this.engineName=e;var t=this.serialize();return n.exports.storage.local.set(e,{engineData:t.toString(),enabled:void 0===this.enabled||this.enabled})}setEngineName(e){this.engineName=e;}}var Ye=new class{constructor(){this.displayCountAsBadgeText(!0);}displayCountAsBadgeText(e){n.exports.declarativeNetRequest.setExtensionActionOptions({displayActionCountAsBadgeText:e});}_setBadgeColor(){n.exports.action.setBadgeBackgroundColor({color:"rgba(85, 85, 85, 1)"});}update(e){e&&this._setIcon(!bn.PAUSED_BLOCKING,e);}async _setIcon(e,t){if(t<0)return;var s="./static/images/icon/toolbar-icon-19.png";let i=await this._getHostInfo(t),r=i.hostname,n$1=i.isHttp;e?r&&n$1&&(yn.debug(`${r} setIcon`),bn.CUSTOMWHITELIST.includes(r)?s="./static/images/icon/disable-toolbar-icon-19.png":"new-tab-page"!==r&&(s="./static/images/icon/check-toolbar-icon-19.png")):s="./static/images/icon/gray-toolbar-icon-19.png",yn.debug(`${s}/${t} setIcon`),n.exports.action.setIcon({path:{19:s},tabId:t}).catch((e=>{yn.error(`set icon error, ${e}`);}));}async _getHostInfo(e){let t=(await n.exports.tabs.get(e)).url;return {hostname:u(t).hostname,isHttp:t.includes("http://")||t.includes("https://")}}};var Je=new class{constructor(){}onRuleMatchedDebug(e){yn.debug("RequestUrl: "+e.request.url),yn.debug("RuleInfo: "+e.rule.rulesetId+"\t"+e.rule.ruleId);}onBeforeNavigate(e){const{tabId:t,frameId:s,url:i}=e;0===s&&(yn.verbose(`Tab ${t} navigate to ${i}`),Ye.update(t));}onCommitted(e){const{tabId:t,frameId:s,transitionType:i,transitionQualifiers:r}=e;0===s&&Ye.update(t);}onTabReplaced(e,t){Ye.update(e);}onTabActivated(e){Ye.update(e.tabId);}static fromWebRequestDetails(e){const t=e.url,s=u(t).hostname,i=u(t).domain,r=e.initiator||e.originUrl||e.documentUrl,n=u(r).domain,o=u(r).hostname;return ht.fromRawDetails(n?{url:t,type:e.type,tabId:e.tabId,requestId:e.requestId,hostname:s,domain:i,sourceUrl:r,sourceDomain:n,sourceHostname:o,_originalRequestDetails:e}:{url:t,type:e.type,tabId:e.tabId,requestId:e.requestId,hostname:s,domain:i,_originalRequestDetails:e})}};const et=chrome||et;var tt=!1,st=Date.now();function it(e,t,{tabId:s,frameId:i,allFrames:r=!1}){if(0===e.length)return;if(t&&t.startsWith("chrome://"))return;yn.debug(`inject CSS with tabID: ${s}`);let n$1=e+"{display:none}";n.exports.scripting.insertCSS({css:n$1,target:r?{tabId:s,allFrames:r}:{tabId:s,allFrames:r,frameIds:i}});}function rt(){bn.ACTIVED_ENGINE&&bn.ACTIVED_ENGINE[0]&&bn.ACTIVED_ENGINE[0].enableBlocking();}function nt(){bn.ACTIVED_ENGINE&&bn.ACTIVED_ENGINE[0]&&bn.ACTIVED_ENGINE[0].disableBlocking();}async function ot(e){!async function(e){var t,s=[],i=[];for(var r in bn.ENGINEINFO){const e=bn.ENGINEINFO[r];e.enabled&&("ad"===e.category?s.push(e.url):"tracker"===e.category&&i.push(e.url));}(t=await Qe.fromLists(fetch,s)).setEngineName("adEngine"),bn.setEngine(t);let n$1=await bn.getGDPR();n$1&&!bn.PAUSED_BLOCKING||t.disableBlocking();e&&n$1&&!bn.PAUSED_BLOCKING&&(yn.debug("first start adblocker"),t.enableBlocking(),n.exports.tabs.reload());}(e),n.exports.webNavigation.onBeforeNavigate.addListener(Je.onBeforeNavigate),n.exports.webNavigation.onCommitted.addListener(Je.onCommitted),n.exports.webNavigation.onDOMContentLoaded.addListener(Je.onDOMContentLoaded),n.exports.tabs.onReplaced.addListener(Je.onTabReplaced),n.exports.tabs.onActivated.addListener(Je.onTabActivated),n.exports.declarativeNetRequest.onRuleMatchedDebug.addListener(Je.onRuleMatchedDebug),function(e){lt(!0),bn.PAUSED_BLOCKING?nt():rt();e||Tm();}(e);}function lt(e=!1){let t=Date.now();(t-st>bn.ONE_DAY||e)&&(st=t,bn.checkTotalInstalledDays());}n.exports.runtime.onMessage.addListener((async function(e,t){let s=await bn.getGDPR();if("getCosmeticsFilters"===e.cmd){if(bn.PAUSED_BLOCKING)return Promise.resolve("false");if(!s)return Promise.resolve("false");let e=t.url,n=u(e),o=n.hostname||"",l=n.domain||"";if(!bn.ACTIVED_ENGINE||0===bn.ACTIVED_ENGINE.length)return Promise.resolve("false");if(l&&bn.CUSTOMWHITELIST.includes(o))return Promise.resolve("false");var i=[],r="";for(let s=0;s<bn.ACTIVED_ENGINE.length;s++){let n=bn.ACTIVED_ENGINE[s];const{active:a,styles:c,scripts:h}=n.getCosmeticsFilters({domain:l,hostname:o,url:e});if(!1===a)return Promise.resolve("false");it(c,t.tab.url,{tabId:t.tab.id,allFrames:!0}),i=i.concat(c.split("\n")),r+=c;}if(0!==i.length)return Promise.resolve({styles:i,styleString:r})}else {if("setPausedForPopup"===e.cmd){bn.PAUSED_BLOCKING=e.paused,bn.PAUSED_BLOCKING?nt():rt();let t=await _m();return Ye.update(t.id),Promise.resolve()}if("setGDPRForPopup"===e.cmd)bn.ACCEPT_GDPR=!0,bm.trackEvent(wm.gdprAcceptPopup),Tm(),rt(),n.exports.tabs.reload();else if("setUnblockedForPopup"===e.cmd){e.isUnBlocked?bn.CUSTOMWHITELIST.push(e.site):Sm(bn.CUSTOMWHITELIST,e.site);let t=await _m();Ye.update(t.id);}else if("setBlockedCountFromContent"===e.cmd)await _m(),amount=amount||0,amount+=e.count,bn.TOTAL_BLOCKED+=e.count,yn.debug(`css: ${e.count}`),Im("kTotalCount",bn.TOTAL_BLOCKED),Ye.update(t.tab.id),tt&&n.exports.runtime.sendMessage({cmd:"setBlockedCount",count:amount,total:bn.TOTAL_BLOCKED}).catch((e=>{}));else if("getBlockedAmountForPopup"===e.cmd){let e=await _m();e&&Ye.update(e.id);}else if("popupShow"===e.cmd)tt=!0,lt();else if("AccecptGDPR"===e.cmd){if(Im("kHasAcceptedGDPR",!0),bn.ACCEPT_GDPR=!0,bm.trackEvent(wm.gdprAcceptWelcome),Tm(),rt(),"chrome"===bn.BROWSER_INFO.name)return Promise.resolve("true");{let e=(await _m()).id;n.exports.tabs.remove(e);}}else {if("isPausedOrUnBlocked"===e.cmd)return !s||bn.PAUSED_BLOCKING||bn.CUSTOMWHITELIST.includes(e.domain)?Promise.resolve("true"):Promise.resolve("false");if("trackEvent"===e.cmd){let t=e.eventName||"",s=e.eventProperties||{};t&&bm.trackEvent(t,s);}}}return !1})),n.exports.runtime.onConnect.addListener((function(e){"popup"===e.name&&e.onDisconnect.addListener((function(){tt=!1;}));})),n.exports.runtime.onInstalled.addListener((function(e){if("install"===e.reason){bm.trackEvent(wm.newInstall);let e=Date.now();Im("kInstalledDate",e).then((()=>{ot();})),Im("kFirstVersion",n.exports.runtime.getManifest().version),n.exports.tabs.create({url:"./static/page/welcome.html"}),Im("kIsPaused",!1);}else "update"===e.reason||e.reason;})),n.exports.runtime.onStartup.addListener((()=>{ot(!0);})),ot(!1);
