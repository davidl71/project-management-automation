var os=Object.defineProperty;var cs=(a,t,e)=>t in a?os(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var i=(a,t,e)=>cs(a,typeof t!="symbol"?t+"":t,e);import{gl as m,c9 as D,bk as ls,bc as ds,gm as rt,gn as hs,eD as me,eB as _e,eF as Se,go as Mt,bQ as nt,H as us,gp as ys,gq as ms,G as fe,gr as pe,cM as ge,gs as S,gt as Vt,eo as Ee,gu as Gt,gv as ke,gw as xt,cN as Ie,gx as Ht,er as Ce,gy as $t,et as be,ex as Te,gz as Kt,gA as Yt,gB as qt,gC as we,gD as Ae,gE as jt,gF as zt,gG as Zt,fu as _s,cc as F,v as ht,a1 as De,eu as Ue,gH as ve,gI as Me,eh as Ne,ei as Le,en as Oe,gJ as Re,gK as Fe,gL as Be,es as Pe,gM as We,gN as Ve,gO as Ge,gP as xe,gQ as He,eE as $e,eC as Ke,eG as Ye,gR as Ss,gS as O,fJ as Y,gT as y,gU as fs,gV as ps,gW as gs,gX as Ot,ej as Rt,ek as Ft,aD as Es,aE as ks,A as ot,gY as Is,gZ as Cs,g_ as bs,g$ as Ts,dM as ws,a as f,P as M,$ as As,j as W,h0 as dt,a2 as Ds,J as qe,K as je,U as Us,h1 as vs,h2 as Ms,h3 as At,h4 as Xt,M as Ns,h5 as Qt,fP as Jt,aM as Ls,O as Os,bL as Rs,cZ as te}from"./CategoryPickerMenu.js";var Nt=(a=>(a.FILE_SIZE_IS_TOO_BIG="FILE_SIZE_IS_TOO_BIG",a.FAILED_TO_GET_UPLOAD_REQUEST="FAILED_TO_GET_UPLOAD_REQUEST",a.FAILED_TO_UPLOAD="FAILED_TO_UPLOAD",a))(Nt||{});const ct=m.createGetDefaultProperty({fileId:null,taskId:null,type:null,originalFileName:""});class Bt{constructor(t){i(this,"fileId");i(this,"taskId");i(this,"type");i(this,"originalFileName");this.fileId=ct("fileId",t),this.taskId=ct("taskId",t),this.type=ct("type",t),this.originalFileName=ct("originalFileName",t)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(Bt,this,t,e)}}const et=m.createGetDefaultProperty({taskId:null,fileId:"",progress:0,originalFileName:"",error:!1});class ft{constructor(t){i(this,"taskId");i(this,"fileId");i(this,"progress");i(this,"originalFileName");i(this,"error");this.taskId=et("taskId",t),this.fileId=et("fileId",t),this.progress=et("progress",t),this.originalFileName=et("originalFileName",t),this.error=et("error",t)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(ft,this,t,e)}}const g=m.createGetDefaultProperty({id:D,name:"",description:"",creationDate:0,currentUserBoards:{},currentUserGroceryBoards:{},spaceType:ls.Work,spacePermissions:[],members:{},paymentStatus:void 0,metadata:null,metadataUpdateTime:null,lastUpdateDate:void 0,aiFeaturesEnabled:!1,aiFeatureConsent:!1,maxAllowedMembers:0,showCheckboxForCards:ds.Never,userInfoLastUpdateDate:null,metadataSyncCounter:null,dirty:0});var le;le=rt;const z=class z{constructor(t){i(this,"id");i(this,"dirty");i(this,"name");i(this,"description");i(this,"creationDate");i(this,"currentUserBoards");i(this,"currentUserGroceryBoards");i(this,"spaceType");i(this,"spacePermissions");i(this,"members");i(this,"paymentStatus");i(this,"metadata");i(this,"metadataUpdateTime");i(this,"lastUpdateDate");i(this,"aiFeaturesEnabled");i(this,"aiFeatureConsent");i(this,"userInfoLastUpdateDate");i(this,"metadataSyncCounter");i(this,"maxAllowedMembers");i(this,"showCheckboxForCards");if(this.id=g("id",t),this.dirty=g("dirty",t),this.name=g("name",t),this.description=g("description",t),this.creationDate=g("creationDate",t),this.currentUserBoards=g("currentUserBoards",t),this.currentUserGroceryBoards=g("currentUserGroceryBoards",t),this.spaceType=g("spaceType",t),this.spacePermissions=g("spacePermissions",t),this.members=g("members",t),this.paymentStatus=g("paymentStatus",t),this.metadata=g("metadata",t),this.metadataUpdateTime=g("metadataUpdateTime",t),this.lastUpdateDate=g("lastUpdateDate",t),this.aiFeaturesEnabled=g("aiFeaturesEnabled",t),this.aiFeatureConsent=g("aiFeatureConsent",t),this.metadataSyncCounter=g("metadataSyncCounter",t),this.userInfoLastUpdateDate=g("userInfoLastUpdateDate",t),this.maxAllowedMembers=g("maxAllowedMembers",t),this.showCheckboxForCards=g("showCheckboxForCards",t),this.id===D)throw new Error("SpaceRecord: `id` wasn't initialized")}static create(t){return new z(t)}static setImmutable(t,e,r){return m.updateImmutableInstace(z,t,e,r)}static setMutable(t,e,r){t[e]=r}static isKeyEqual(t,e,r){return m.isEqual(t[e],r)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(z,this,t,e)}};i(z,le,!0);let ut=z;const v=m.createGetDefaultProperty({id:D,spaceId:D,name:"",creationDate:0,status:hs.ACTIVE,position:null,metadata:null,lastUpdateDate:void 0,nameUpdateTime:null,positionUpdateTime:null,statusUpdateTime:null,metadataUpdateTime:null,nameSyncCounter:null,metadataSyncCounter:null,dirty:0});var de;de=rt;const Z=class Z{constructor(t){i(this,"id");i(this,"spaceId");i(this,"name");i(this,"creationDate");i(this,"status");i(this,"position");i(this,"metadata");i(this,"lastUpdateDate");i(this,"nameUpdateTime");i(this,"positionUpdateTime");i(this,"statusUpdateTime");i(this,"metadataUpdateTime");i(this,"dirty");i(this,"nameSyncCounter");i(this,"metadataSyncCounter");if(this.id=v("id",t),this.spaceId=v("spaceId",t),this.name=v("name",t),this.creationDate=v("creationDate",t),this.status=v("status",t),this.position=v("position",t),this.metadata=v("metadata",t),this.lastUpdateDate=v("lastUpdateDate",t),this.nameUpdateTime=v("nameUpdateTime",t),this.positionUpdateTime=v("positionUpdateTime",t),this.statusUpdateTime=v("statusUpdateTime",t),this.metadataUpdateTime=v("metadataUpdateTime",t),this.dirty=v("dirty",t),this.nameSyncCounter=v("nameSyncCounter",t),this.metadataSyncCounter=v("metadataSyncCounter",t),this.id===D)throw new Error("CustomViewRecord: `id` wasn't initialized")}static create(t){return new Z(t)}static setImmutable(t,e,r){return m.updateImmutableInstace(Z,t,e,r)}static setMutable(t,e,r){t[e]=r}static isKeyEqual(t,e,r){return m.isEqual(t[e],r)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(Z,this,t,e)}};i(Z,de,!0);let yt=Z;const b=m.createGetDefaultProperty({id:D,cardId:D,name:"",creationDate:0,status:me.ACTIVE,position:null,hideCheckedItems:0,lastUpdateDate:void 0,nameUpdateTime:null,positionUpdateTime:null,statusUpdateTime:null,cardIdUpdateTime:null,hideCheckedItemsUpdateTime:null,positionSyncCounter:null,nameSyncCounter:null,statusSyncCounter:null,hideCheckedItemsSyncCounter:null,dirty:0});var he;he=rt;const X=class X{constructor(t){i(this,"id");i(this,"cardId");i(this,"cardIdUpdateTime");i(this,"creationDate");i(this,"dirty");i(this,"lastUpdateDate");i(this,"name");i(this,"nameSyncCounter");i(this,"nameUpdateTime");i(this,"position");i(this,"positionSyncCounter");i(this,"positionUpdateTime");i(this,"status");i(this,"statusSyncCounter");i(this,"statusUpdateTime");i(this,"hideCheckedItems");i(this,"hideCheckedItemsUpdateTime");i(this,"hideCheckedItemsSyncCounter");if(this.id=b("id",t),this.cardId=b("cardId",t),this.cardIdUpdateTime=b("cardIdUpdateTime",t),this.creationDate=b("creationDate",t),this.dirty=b("dirty",t),this.lastUpdateDate=b("lastUpdateDate",t),this.name=b("name",t),this.nameSyncCounter=b("nameSyncCounter",t),this.nameUpdateTime=b("nameUpdateTime",t),this.position=b("position",t),this.positionSyncCounter=b("positionSyncCounter",t),this.positionUpdateTime=b("positionUpdateTime",t),this.status=b("status",t),this.statusSyncCounter=b("statusSyncCounter",t),this.statusUpdateTime=b("statusUpdateTime",t),this.hideCheckedItems=b("hideCheckedItems",t),this.hideCheckedItemsSyncCounter=b("hideCheckedItemsSyncCounter",t),this.hideCheckedItemsUpdateTime=b("hideCheckedItemsUpdateTime",t),this.id===D)throw new Error("CardChecklistRecord: `id` wasn't initialized")}static create(t){return new X(t)}static setImmutable(t,e,r){return m.updateImmutableInstace(X,t,e,r)}static setMutable(t,e,r){t[e]=r}static isKeyEqual(t,e,r){return m.isEqual(t[e],r)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(X,this,t,e)}};i(X,he,!0);let mt=X;const p=m.createGetDefaultProperty({id:D,checklistId:D,name:"",creationDate:0,status:_e.ACTIVE,position:null,dueDate:null,owners:null,lastUpdateDate:void 0,nameUpdateTime:null,positionUpdateTime:null,statusUpdateTime:null,checklistIdUpdateTime:null,dueDateUpdateTime:null,ownersUpdateTime:null,positionSyncCounter:null,nameSyncCounter:null,dueDateSyncCounter:null,ownersSyncCounter:null,statusSyncCounter:null,dirty:0});var ue;ue=rt;const Q=class Q{constructor(t){i(this,"id");i(this,"checklistId");i(this,"checklistIdUpdateTime");i(this,"creationDate");i(this,"dirty");i(this,"lastUpdateDate");i(this,"name");i(this,"nameSyncCounter");i(this,"nameUpdateTime");i(this,"position");i(this,"positionSyncCounter");i(this,"positionUpdateTime");i(this,"status");i(this,"statusSyncCounter");i(this,"statusUpdateTime");i(this,"dueDate");i(this,"dueDateSyncCounter");i(this,"dueDateUpdateTime");i(this,"owners");i(this,"ownersSyncCounter");i(this,"ownersUpdateTime");if(this.id=p("id",t),this.checklistId=p("checklistId",t),this.checklistIdUpdateTime=p("checklistIdUpdateTime",t),this.creationDate=p("creationDate",t),this.dirty=p("dirty",t),this.lastUpdateDate=p("lastUpdateDate",t),this.name=p("name",t),this.nameSyncCounter=p("nameSyncCounter",t),this.nameUpdateTime=p("nameUpdateTime",t),this.position=p("position",t),this.positionSyncCounter=p("positionSyncCounter",t),this.positionUpdateTime=p("positionUpdateTime",t),this.status=p("status",t),this.statusSyncCounter=p("statusSyncCounter",t),this.statusUpdateTime=p("statusUpdateTime",t),this.dueDate=p("dueDate",t),this.dueDateSyncCounter=p("dueDateSyncCounter",t),this.dueDateUpdateTime=p("dueDateUpdateTime",t),this.owners=p("owners",t),this.ownersSyncCounter=p("ownersSyncCounter",t),this.ownersUpdateTime=p("ownersUpdateTime",t),this.id===D)throw new Error("CardChecklistItemRecord: `id` wasn't initialized")}static create(t){return new Q(t)}static setImmutable(t,e,r){return m.updateImmutableInstace(Q,t,e,r)}static setMutable(t,e,r){t[e]=r}static isKeyEqual(t,e,r){return m.isEqual(t[e],r)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(Q,this,t,e)}};i(Q,ue,!0);let _t=Q;const N=m.createGetDefaultProperty({id:D,cardId:D,creationDate:0,status:Se.ACTIVE,displayName:"",duration:null,fileSize:null,mimeType:null,url:"",lastUpdateDate:void 0,statusUpdateTime:null,statusSyncCounter:null,dirty:0});var ye;ye=rt;const J=class J{constructor(t){i(this,"id");i(this,"cardId");i(this,"creationDate");i(this,"dirty");i(this,"status");i(this,"displayName");i(this,"duration");i(this,"fileSize");i(this,"lastUpdateDate");i(this,"mimeType");i(this,"url");i(this,"statusSyncCounter");i(this,"statusUpdateTime");if(this.id=N("id",t),this.cardId=N("cardId",t),this.creationDate=N("creationDate",t),this.dirty=N("dirty",t),this.lastUpdateDate=N("lastUpdateDate",t),this.displayName=N("displayName",t),this.duration=N("duration",t),this.fileSize=N("fileSize",t),this.url=N("url",t),this.mimeType=N("mimeType",t),this.status=N("status",t),this.statusSyncCounter=N("statusSyncCounter",t),this.statusUpdateTime=N("statusUpdateTime",t),this.id===D)throw new Error("CardAttachmentRecord: `id` wasn't initialized")}static create(t){return new J(t)}static setImmutable(t,e,r){return m.updateImmutableInstace(J,t,e,r)}static setMutable(t,e,r){t[e]=r}static isKeyEqual(t,e,r){return m.isEqual(t[e],r)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(J,this,t,e)}};i(J,ye,!0);let St=J;const B=m.createGetDefaultProperty({id:D,groceryBoardId:D,groceryCategoryId:0,creationDate:0,lastUpdateDate:null,name:"",nameUpdateTime:null,nameSyncCounter:null,dirty:0});class at{constructor(t){i(this,"id");i(this,"groceryBoardId");i(this,"groceryCategoryId");i(this,"creationDate");i(this,"lastUpdateDate");i(this,"name");i(this,"nameUpdateTime");i(this,"nameSyncCounter");i(this,"dirty");this.id=B("id",t),this.groceryBoardId=B("groceryBoardId",t),this.groceryCategoryId=B("groceryCategoryId",t),this.creationDate=B("creationDate",t),this.lastUpdateDate=B("lastUpdateDate",t),this.name=B("name",t),this.nameUpdateTime=B("nameUpdateTime",t),this.nameSyncCounter=B("nameSyncCounter",t),this.dirty=B("dirty",t)}static create(t){return new at(t)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(at,this,t,e)}}const U=m.createGetDefaultProperty({id:D,grocerySectionId:D,grocerySectionIdUpdateTime:null,grocerySectionIdSyncCounter:null,creationDate:0,lastUpdateDate:null,name:"",nameUpdateTime:null,nameSyncCounter:null,position:null,positionUpdateTime:null,positionSyncCounter:null,status:Mt.Active,statusUpdateTime:null,statusSyncCounter:null,dirty:0,pendingInitialSync:null});class tt{constructor(t){i(this,"id");i(this,"grocerySectionId");i(this,"grocerySectionIdUpdateTime");i(this,"grocerySectionIdSyncCounter");i(this,"creationDate");i(this,"lastUpdateDate");i(this,"position");i(this,"positionUpdateTime");i(this,"positionSyncCounter");i(this,"name");i(this,"nameUpdateTime");i(this,"nameSyncCounter");i(this,"status");i(this,"statusUpdateTime");i(this,"statusSyncCounter");i(this,"dirty");i(this,"pendingInitialSync");this.id=U("id",t),this.grocerySectionId=U("grocerySectionId",t),this.grocerySectionIdUpdateTime=U("grocerySectionIdUpdateTime",t),this.grocerySectionIdSyncCounter=U("grocerySectionIdSyncCounter",t),this.creationDate=U("creationDate",t),this.lastUpdateDate=U("lastUpdateDate",t),this.position=U("position",t),this.positionUpdateTime=U("positionUpdateTime",t),this.positionSyncCounter=U("positionSyncCounter",t),this.name=U("name",t),this.nameUpdateTime=U("nameUpdateTime",t),this.nameSyncCounter=U("nameSyncCounter",t),this.status=U("status",t),this.statusUpdateTime=U("statusUpdateTime",t),this.statusSyncCounter=U("statusSyncCounter",t),this.dirty=U("dirty",t),this.pendingInitialSync=U("pendingInitialSync",t)}static create(t){return new tt(t)}static setImmutable(t,e,r){return m.updateImmutableInstace(tt,t,e,r)}get(t){return this[t]}set(t,e){return m.updateImmutableInstace(tt,this,t,e)}}function Fs(a,t){return a.includes(t)}function Bs(a,t){return a!==null&&t in a}function Ps(a){const t=a.type.split("/")[0];return t!=="audio"&&t!=="video"?Promise.resolve(null):new Promise(e=>{var r=document.createElement(t);r.preload="metadata",r.onloadedmetadata=function(){const{duration:s}=r;if(window.URL.revokeObjectURL(r.src),isNaN(s))return e(null);const n=Math.round(s*1e3);e(n)},r.src=window.URL.createObjectURL(a)})}class La{constructor({auth:t,batch:e}){i(this,"_auth");i(this,"_uploadsMetadata",new Map);i(this,"_progressEventEmitter");i(this,"_doneEventEmitter");i(this,"_errorEventEmitter");i(this,"_abortEventEmitter");i(this,"subscribeProgress");i(this,"subscribeDone");i(this,"subscribeError");i(this,"subscribeAbort");i(this,"_handleFileUploadRequestError",t=>{const e=this._getFileMetadataFromXhr(t),r=e==null?null:e.fileId,s=e==null||e.taskId==null?null:e.taskId;this._emitErrorEvent(t,{type:Nt.FAILED_TO_GET_UPLOAD_REQUEST,fileId:r,taskId:s,originalFileName:(e==null?void 0:e.originalFileName)||""})});i(this,"_handleXhrErrorEvent",t=>{const e=this._getFileMetadataFromXhr(t.currentTarget),r=e==null?null:e.fileId,s=e==null||e.taskId==null?null:e.taskId;this._emitErrorEvent(t.currentTarget,{type:Nt.FAILED_TO_UPLOAD,fileId:r,taskId:s,originalFileName:(e==null?void 0:e.originalFileName)||""})});i(this,"_handleProgressEvent",t=>{this._emitProgressEvent(t.currentTarget,t.loaded,t.total)});i(this,"_handleOnloadStartEvent",t=>{this._emitProgressEvent(t.currentTarget,t.loaded,t.total)});i(this,"_handleAbortEvent",t=>{this._emitAbortEvent(t.currentTarget)});this._auth=t,this._progressEventEmitter=nt({batch:e}),this._doneEventEmitter=nt({batch:e}),this._errorEventEmitter=nt({batch:e}),this._abortEventEmitter=nt({batch:e}),this.subscribeProgress=this._progressEventEmitter.on,this.subscribeDone=this._doneEventEmitter.on,this.subscribeError=this._errorEventEmitter.on,this.subscribeAbort=this._abortEventEmitter.on}destroy(){this._progressEventEmitter.off(),this._doneEventEmitter.off(),this._errorEventEmitter.off(),this._abortEventEmitter.off(),this._auth=void 0,this._progressEventEmitter=void 0,this._doneEventEmitter=void 0,this._errorEventEmitter=void 0,this._abortEventEmitter=void 0}_getFileMetadataFromXhr(t){for(var e of this._uploadsMetadata.values())if(e.xhr!=null&&e.xhr.upload===t)return e}_uploadFile(t,e,r){const s=us(r==="card_attachment"?"uuid4":"classic"),n=new XMLHttpRequest,c={xhr:n,originalFileName:t.name};n.upload.addEventListener("error",this._handleXhrErrorEvent),n.upload.addEventListener("progress",this._handleProgressEvent),n.upload.addEventListener("loadstart",this._handleOnloadStartEvent),n.upload.addEventListener("abort",this._handleAbortEvent),n.addEventListener("readystatechange",()=>{n.readyState===4&&this._emitDoneEvent(n.upload)}),Promise.all([Ps(t),ee(this._auth,t,r)]).then(([l,d])=>{this._uploadsMetadata.set(s,{fileId:s,xhr:c.xhr,uploadRequest:d,taskId:e,originalFileName:c.originalFileName,mimeType:t.type,fileSize:t.size,duration:l}),se(n,d,t)}).catch(l=>{this._handleFileUploadRequestError(n)})}_emitProgressEvent(t,e,r){const s=this._getFileMetadataFromXhr(t);if(s===void 0)return;const{fileId:n,taskId:c,originalFileName:l}=s;n!=null&&c!=null&&l!=null&&this._progressEventEmitter.emit({fileId:n,progress:e/r*100,taskId:c,originalFileName:l})}_emitDoneEvent(t){const e=this._getFileMetadataFromXhr(t),r=e==null?null:e.fileId,s=e==null?null:e.uploadRequest,n=e==null?null:e.originalFileName,c=e==null||e.mimeType==null?null:e.mimeType,l=e==null||e.taskId==null?null:e.taskId,d=e==null?null:e.fileSize,u=e==null?null:e.duration;r!=null&&s!=null&&n!=null&&d!=null&&(this._uploadsMetadata.delete(r),this._doneEventEmitter.emit({fileId:r,url:ae(s),taskId:l,originalFileName:n,fileSize:d,duration:u,mimeType:c}))}_emitAbortEvent(t){const e=this._getFileMetadataFromXhr(t),r=e==null||e.taskId==null?null:e.taskId,s=e==null?null:e.fileId;s!=null&&this._abortEventEmitter.emit({fileId:s,taskId:r})}_emitErrorEvent(t,e){const r=this._getFileMetadataFromXhr(t),s=r==null||r.taskId==null?null:r.taskId,n=r==null?null:r.fileId;this._errorEventEmitter.emit(new Bt({...e,fileId:n,taskId:s}))}uploadFiles(t,e,r){for(let s of t)this._uploadFile(s,e,r)}abortUpload(t){const e=this._uploadsMetadata.get(t);e!=null&&e.xhr!=null&&(e.xhr.abort(),this._uploadsMetadata.delete(t))}async uploadFile(t,e,r){const s=await ee(this._auth,t,e,r),n=new XMLHttpRequest;return await new Promise((c,l)=>{n.upload.addEventListener("error",l),n.upload.addEventListener("abort",l),n.upload.addEventListener("load",c),se(n,s,t)}),{url:ae(s)}}}function ee(a,t,e,r){const s=new URLSearchParams;s.set("S3ObjectType",t.type),s.set("S3ObjectName",t.name);const n=e==="card_attachment"?e:"attachment";return s.set("UploadType",n),ys(ms+"?"+s.toString(),{method:"GET",headers:a.createHeaders({hasToken:!0}),signal:r})}function se(a,t,e){if(a.withCredentials==null)throw new Error("No CORS support.");const r=new FormData;Object.keys(t.fields).forEach(s=>{r.append(s,t.fields[s])}),r.append("file",e),a.open("POST",t.url,!0),a.setRequestHeader("Content-Disposition","attachment; filename="+encodeURIComponent(e.name)),a.send(r)}function ae(a){return a.url+a.fields.key}class Ws{constructor(t){i(this,"isFirstSync",!0);i(this,"clientSyncCounter",1);i(this,"lastServerSyncId",-1);i(this,"lastUpdateDate",Number.MIN_VALUE);i(this,"isSyncing",!1);i(this,"attachment",new Map);i(this,"category",new Map);i(this,"label",new Map);i(this,"task",new Map);i(this,"space",new Map);i(this,"board",new Map);i(this,"section",new Map);i(this,"userCustomView",new Map);i(this,"card",new Map);i(this,"tag",new Map);i(this,"myDayEntry",new Map);i(this,"user",new Map);i(this,"groceryBoard",new Map);i(this,"grocerySection",new Map);i(this,"groceryCard",new Map);i(this,"cardChecklist",new Map);i(this,"checklistItem",new Map);i(this,"cardAttachment",new Map);i(this,"categoriesUncheckedTaskIds",new Map);i(this,"spacesBoardIds",new Map);i(this,"boardsSectionIds",new Map);i(this,"boardsTeamsTagIds",new Map);i(this,"sectionsCardIds",new Map);i(this,"tasksMyDayEntryIds",new Map);i(this,"tasksAttachmentsIds",new Map);i(this,"tasksUncheckedSubTasksIds",new Map);i(this,"tasksCheckedSubTasksIds",new Map);i(this,"groceryBoardsSectionIds",new Map);i(this,"grocerySectionsCardIds",new Map);if(this.reset(),t){const{lastUpdateDate:e,updates:r}=t;for(const s of Object.keys(r))if(Bs(r,s))for(const n of r[s].values())this.set(s,n);this.lastUpdateDate=e}}isDirty(){return T(this.attachment)||T(this.category)||T(this.label)||T(this.task)||T(this.space)||T(this.board)||T(this.section)||T(this.userCustomView)||T(this.card)||T(this.tag)||T(this.myDayEntry)||T(this.user)||T(this.groceryBoard)||T(this.grocerySection)||T(this.groceryCard)||T(this.cardChecklist)||T(this.checklistItem)||T(this.cardAttachment)||!1}getAllDirtyIds(){return{attachment:E(this.attachment),category:E(this.category),label:E(this.label),task:E(this.task),space:E(this.space),board:E(this.board),section:E(this.section),userCustomView:E(this.userCustomView),card:E(this.card),tag:E(this.tag),myDayEntry:E(this.myDayEntry),user:E(this.user),groceryBoard:E(this.groceryBoard),grocerySection:E(this.grocerySection),groceryCard:E(this.groceryCard),cardChecklist:E(this.cardChecklist),checklistItem:E(this.checklistItem),cardAttachment:E(this.cardAttachment)}}getAllDirtyIdsOf(t){return E(this[t])}delete(t,e){switch(t){case"attachment":return this._deleteAttachment(e);case"task":return this._deleteTask(e);case"card":return this._deleteCard(e);case"section":return this._deleteSection(e);case"board":return this._deleteBoard(e);case"tag":return this._deleteTag(e);case"myDayEntry":return this._deleteMyDayEntry(e);case"user":return this._deleteUser(e);case"category":case"label":case"space":case"userCustomView":case"cardChecklist":case"checklistItem":case"cardAttachment":return void this[t].delete(e);case"groceryBoard":return this._deleteGroceryBoard(e);case"grocerySection":return this._deleteGrocerySection(e);case"groceryCard":return this._deleteGroceryCard(e);default:this[t].delete(e)}}set(t,e){switch(t){case"attachment":this._setAttachment(e);break;case"category":this.category.set(e.id,pe.create(e));break;case"label":this.label.set(e.id,fe.create(e));break;case"cardChecklist":this.cardChecklist.set(e.id,mt.create(e));break;case"checklistItem":this.checklistItem.set(e.id,_t.create(e));break;case"cardAttachment":this.cardAttachment.set(e.id,St.create(e));break;case"task":this._setTask(e);break;case"space":this.space.set(e.id,ut.create(e));break;case"board":this._setBoard(e);break;case"section":this._setSection(e);break;case"userCustomView":this.userCustomView.set(e.id,yt.create(e));break;case"card":this._setCard(e);break;case"myDayEntry":this._setMyDayEntry(e);break;case"tag":this._setTag(e);break;case"user":this._setUser(e);break;case"groceryBoard":this._setGroceryBoard(e);break;case"grocerySection":this._setGrocerySection(e);break;case"groceryCard":this._setGroceryCard(e);break;default:throw new Error(`StoreSync#set(): type "${t}" isn't supported`)}}reset(){this.isFirstSync=!0,this.lastUpdateDate=0,this.clientSyncCounter=1,this.lastServerSyncId=-1,this.isSyncing=!1,this.attachment.clear(),this.category.clear(),this.label.clear(),this.task.clear(),this.space.clear(),this.board.clear(),this.section.clear(),this.userCustomView.clear(),this.card.clear(),this.tag.clear(),this.user.clear(),this.myDayEntry.clear(),this.groceryBoard.clear(),this.grocerySection.clear(),this.groceryCard.clear(),this.cardChecklist.clear(),this.checklistItem.clear(),this.cardAttachment.clear(),this.categoriesUncheckedTaskIds.clear(),this.spacesBoardIds.clear(),this.boardsSectionIds.clear(),this.sectionsCardIds.clear(),this.boardsTeamsTagIds.clear(),this.tasksMyDayEntryIds.clear(),this.tasksAttachmentsIds.clear(),this.tasksUncheckedSubTasksIds.clear(),this.tasksCheckedSubTasksIds.clear(),this.groceryBoardsSectionIds.clear(),this.grocerySectionsCardIds.clear()}_setAttachment(t){const{id:e}=t,r=this.attachment.get(e),s=ge.create(t);this.attachment.set(e,s),S({relationship:this.tasksAttachmentsIds,relationshipMapper:Vt,prevModel:r,model:s,isImmutable:!0})}_setBoard(t){const{id:e}=t,r=this.board.get(e),s=Ee.create(t);this.board.set(e,s),S({relationship:this.spacesBoardIds,relationshipMapper:Gt,prevModel:r,model:s,isImmutable:!1})}_setSection(t){const{id:e}=t,r=this.section.get(e),s=ke.create(t);this.section.set(e,s),S({relationship:this.boardsSectionIds,relationshipMapper:xt,prevModel:r,model:s,isImmutable:!1})}_setCard(t){const{id:e}=t,r=this.card.get(e),s=Ie.create(t);this.card.set(e,s),S({relationship:this.sectionsCardIds,relationshipMapper:Ht,prevModel:r,model:s,isImmutable:!1})}_setTag(t){const{id:e}=t,r=this.tag.get(e),s=Ce.create(t);this.tag.set(e,s),S({relationship:this.boardsTeamsTagIds,relationshipMapper:$t,prevModel:r,model:s,isImmutable:!1})}_setUser(t){const{id:e}=t,r=be.create(t);this.user.set(e,r)}_setTask(t){const{id:e}=t,r=this.task.get(e),s=Te.create(t);this.task.set(e,s),S({relationship:this.categoriesUncheckedTaskIds,relationshipMapper:Kt,prevModel:r,model:s,isImmutable:!1}),S({relationship:this.tasksUncheckedSubTasksIds,relationshipMapper:Yt,prevModel:r,model:s,isImmutable:!0}),S({relationship:this.tasksCheckedSubTasksIds,relationshipMapper:qt,prevModel:r,model:s,isImmutable:!0})}_setMyDayEntry(t){const{id:e}=t,r=we.create(t),{referencedObjectId:s}=r,n=new Set(this.tasksMyDayEntryIds.get(s)).add(r.id);this.tasksMyDayEntryIds.set(s,n),this.myDayEntry.set(e,r)}_setGroceryBoard(t){const{id:e}=t,r=this.groceryBoard.get(e),s=Ae.create(t);this.groceryBoard.set(e,s),S({relationship:this.spacesBoardIds,relationshipMapper:jt,prevModel:r,model:s,isImmutable:!1})}_setGrocerySection(t){const{id:e}=t,r=this.grocerySection.get(e),s=at.create(t);this.grocerySection.set(e,s),S({relationship:this.groceryBoardsSectionIds,relationshipMapper:zt,prevModel:r,model:s,isImmutable:!1})}_setGroceryCard(t){const{id:e}=t,r=this.groceryCard.get(e),s=tt.create(t);this.groceryCard.set(e,s),S({relationship:this.grocerySectionsCardIds,relationshipMapper:Zt,prevModel:r,model:s,isImmutable:!1})}_deleteAttachment(t){const e=this.attachment.get(t);e!=null&&S({relationship:this.tasksAttachmentsIds,relationshipMapper:Vt,prevModel:e,model:void 0,isImmutable:!0}),this.attachment.delete(t)}_deleteTask(t){const e=this.task.get(t);e!=null&&(S({relationship:this.categoriesUncheckedTaskIds,relationshipMapper:Kt,prevModel:e,model:void 0,isImmutable:!1}),S({relationship:this.tasksUncheckedSubTasksIds,relationshipMapper:Yt,prevModel:e,model:void 0,isImmutable:!0}),S({relationship:this.tasksCheckedSubTasksIds,relationshipMapper:qt,prevModel:e,model:void 0,isImmutable:!0})),this.task.delete(t)}_deleteCard(t){const e=this.card.get(t);e!=null&&S({relationship:this.sectionsCardIds,relationshipMapper:Ht,prevModel:e,model:void 0,isImmutable:!1}),this.card.delete(t)}_deleteSection(t){const e=this.section.get(t);e!=null&&S({relationship:this.boardsSectionIds,relationshipMapper:xt,prevModel:e,model:void 0,isImmutable:!1}),this.section.delete(t)}_deleteBoard(t){const e=this.board.get(t);e!=null&&S({relationship:this.spacesBoardIds,relationshipMapper:Gt,prevModel:e,model:void 0,isImmutable:!1}),this.board.delete(t)}_deleteTag(t){const e=this.tag.get(t);e!=null&&S({relationship:this.boardsTeamsTagIds,relationshipMapper:$t,prevModel:e,model:void 0,isImmutable:!1}),this.tag.delete(t)}_deleteUser(t){this.user.delete(t)}_deleteMyDayEntry(t){const e=this.myDayEntry.get(t);if(e!=null){const r=e.referencedObjectId,s=this.tasksMyDayEntryIds.get(r);if(s){const n=new Set(s);n.delete(t),this.tasksMyDayEntryIds.set(r,n)}}this.myDayEntry.delete(t)}_deleteGroceryBoard(t){const e=this.groceryBoard.get(t);e!=null&&S({relationship:this.spacesBoardIds,relationshipMapper:jt,prevModel:e,model:void 0,isImmutable:!1}),this.groceryBoard.delete(t)}_deleteGrocerySection(t){const e=this.grocerySection.get(t);e!=null&&S({relationship:this.groceryBoardsSectionIds,relationshipMapper:zt,prevModel:e,model:void 0,isImmutable:!1}),this.grocerySection.delete(t)}_deleteGroceryCard(t){const e=this.groceryCard.get(t);e!=null&&S({relationship:this.grocerySectionsCardIds,relationshipMapper:Zt,prevModel:e,model:void 0,isImmutable:!1}),this.groceryCard.delete(t)}}function T(a){for(let t of a.values())if(t.dirty===1)return!0;return!1}function E(a){const t=new Set;return a.forEach((e,r)=>{e.dirty===1&&t.add(r)}),t}class Pt{constructor(){i(this,"_DEBUG");i(this,"_listeners",new Map);i(this,"_asapCallbacks",[]);i(this,"_asap",Vs())}countListeners(t){const e=this._listeners.get(t);return e==null?0:e.size}on(t,e){let r=this._listeners.get(t);r==null&&(r=new Set,this._listeners.set(t,r)),r.add(e)}off(t,e){if(t==null){this._listeners.clear();return}const r=this._listeners.get(t);r!=null&&(e==null?(r.clear(),this._listeners.delete(t)):(r.delete(e),r.size===0&&this._listeners.delete(t)))}emit(t,e){let r=this._listeners.get(t);r!=null&&r.forEach(s=>s(e))}emitAsap(t,e){const r=()=>{const n=this._asapCallbacks.findIndex(c=>c.callback===r);n!==-1&&this._asapCallbacks.splice(n,1),this.emit(t,e)},s=this._asap.setNextMicroTask(r);this._asapCallbacks.push({callback:r,eventName:t,asapId:s})}flushAsap(){try{let t;for(;t=this._asapCallbacks.pop();)this._asap.clearNextMicroTask(t.asapId),t.callback()}finally{this._asapCallbacks.splice(0,this._asapCallbacks.length)}}}function Vs(){let a=0;const t=new Set;function e(s){const n=++a;return t.add(n),Promise.resolve().then(()=>{t.has(n)&&(t.delete(n),s())}),n}function r(s){t.delete(s)}return{setNextMicroTask:e,clearNextMicroTask:r}}function Dt(a,t,e){switch(t){case"board":return Gs(a,e);case"section":return ze(a,e)}}function Gs(a,t){const e=a.boardsSectionIds.get(t);e!=null&&e.size&&Array.from(e.values()).forEach(s=>{a.delete("section",s),ze(a,s)});const r=a.boardsTeamsTagIds.get(t);return r!=null&&r.size&&Array.from(r.values()).forEach(s=>{a.delete("tag",s)}),!0}function ze(a,t){const e=a.sectionsCardIds.get(t);return e!=null&&e.size?(Array.from(e.values()).forEach(r=>{a.delete("card",r)}),!0):!1}function xs(a,t){const e=a.spacesBoardIds.get(t.id);if(!(e!=null&&e.size))return[];const r=Object.keys(t.currentUserBoards);return _s(Array.from(e),r)}function Hs(a,t){let e;function r(s){s.dirty=1,s.categoryId=e.id,s.categoryIdSyncCounter=a.clientSyncCounter}for(let s of t.updates.task.values()){if(s.parentGlobalTaskId!=null||s.deleted||s.status!==ht.UNCHECKED&&s.status!==ht.CHECKED)continue;const{categoryId:n}=s;if(!a.category.has(n)){if(e===void 0){for(let c of a.category.values())if(c.isDefault){e=c;break}}if(e===void 0)break;a.set("task",De(s,r))}}}function $s(a,t){t.deletions.board.forEach(e=>{Dt(a,"board",e)}),t.updates.space.forEach(e=>{xs(a,e).forEach(s=>{a.delete("board",s),Dt(a,"board",s)})}),t.deletions.section.forEach(e=>{Dt(a,"section",e)})}function Ks({processedSyncResponse:a,serverSyncId:t,store:e}){if(e.lastUpdateDate>a.lastUpdateDate&&F("Cannot update store with previous lastUpdateDate","commitSyncFetchEvent()"),t!=null&&e.lastServerSyncId>t){const s=`Received syncId (${t}) which smaller or equals than local syncId (${e.lastServerSyncId})`;F(s,"commitSyncFetchEvent()")}a.deletions.attachment.forEach(s=>e.delete("attachment",s)),a.deletions.category.forEach(s=>e.delete("category",s)),a.deletions.label.forEach(s=>e.delete("label",s)),a.deletions.task.forEach(s=>e.delete("task",s)),a.deletions.card.forEach(s=>e.delete("card",s)),a.deletions.section.forEach(s=>e.delete("section",s)),a.deletions.userCustomView.forEach(s=>e.delete("userCustomView",s)),a.deletions.board.forEach(s=>e.delete("board",s)),a.deletions.space.forEach(s=>e.delete("space",s)),a.deletions.myDayEntry.forEach(s=>e.delete("myDayEntry",s)),a.deletions.tag.forEach(s=>e.delete("tag",s)),a.deletions.user.forEach(s=>e.delete("user",s)),a.deletions.groceryBoard.forEach(s=>e.delete("groceryBoard",s)),a.deletions.grocerySection.forEach(s=>e.delete("grocerySection",s)),a.deletions.groceryCard.forEach(s=>e.delete("groceryCard",s)),a.deletions.cardChecklist.forEach(s=>e.delete("cardChecklist",s)),a.deletions.checklistItem.forEach(s=>e.delete("checklistItem",s)),a.deletions.cardAttachment.forEach(s=>e.delete("cardAttachment",s)),a.updates.attachment.forEach(s=>e.set("attachment",s)),a.updates.category.forEach(s=>e.set("category",s)),a.updates.label.forEach(s=>e.set("label",s)),a.updates.task.forEach(s=>e.set("task",s)),a.updates.card.forEach(s=>e.set("card",s)),a.updates.section.forEach(s=>e.set("section",s)),a.updates.userCustomView.forEach(s=>e.set("userCustomView",s)),a.updates.board.forEach(s=>e.set("board",s)),a.updates.space.forEach(s=>e.set("space",s)),a.updates.tag.forEach(s=>e.set("tag",s)),a.updates.myDayEntry.forEach(s=>e.set("myDayEntry",s)),a.updates.user.forEach(s=>e.set("user",s)),a.updates.groceryBoard.forEach(s=>e.set("groceryBoard",s)),a.updates.grocerySection.forEach(s=>e.set("grocerySection",s)),a.updates.groceryCard.forEach(s=>e.set("groceryCard",s)),a.updates.cardChecklist.forEach(s=>e.set("cardChecklist",s)),a.updates.checklistItem.forEach(s=>e.set("checklistItem",s)),a.updates.cardAttachment.forEach(s=>e.set("cardAttachment",s)),e.isFirstSync||$s(e,a),e.isFirstSync=!1,e.lastUpdateDate=a.lastUpdateDate,t!=null&&(e.lastServerSyncId=t);for(let s of a.updates.task.values())if(s.position===ht.UNCHECKED){const n=e.clientSyncCounter,c=De(s,l=>{l.dirty=1,l.status=ht.UNCHECKED,l.statusSyncCounter=n,l.position=null,l.positionSyncCounter=n});e.set("task",c)}Hs(e,a);const r=e.getAllDirtyIdsOf("task");r.size>0&&r.forEach(s=>{const n=e.task.get(s);if(n!=null){if(!e.category.has(n.categoryId)){e.delete("task",s);return}if(n.parentGlobalTaskId!=null&&!e.task.has(n.parentGlobalTaskId)){e.delete("task",s);return}}})}const Ze=0,Oa=3e4,Xe=[Ue,ve,Me,Ne,Le,Oe,Re,Fe,Be,Pe,We,Ve,Ge,xe,He,$e,Ke,Ye];function Ys({store:a,syncResponseDtos:t,isRecoverySync:e}){const r={attachment:new Map,category:new Map,label:new Map,task:new Map,space:new Map,board:new Map,section:new Map,userCustomView:new Map,card:new Map,tag:new Map,myDayEntry:new Map,user:new Map,groceryBoard:new Map,grocerySection:new Map,groceryCard:new Map,cardChecklist:new Map,checklistItem:new Map,cardAttachment:new Map},s={attachment:new Set,category:new Set,label:new Set,task:new Set,space:new Set,board:new Set,section:new Set,userCustomView:new Set,card:new Set,tag:new Set,myDayEntry:new Set,user:new Set,groceryBoard:new Set,grocerySection:new Set,groceryCard:new Set,cardChecklist:new Set,checklistItem:new Set,cardAttachment:new Set};return e&&(s.attachment=new Set(a.attachment.keys()),s.category=new Set(a.category.keys()),s.label=new Set(a.label.keys()),s.task=new Set(a.task.keys()),s.space=new Set(a.space.keys()),s.board=new Set(a.board.keys()),s.section=new Set(a.section.keys()),s.userCustomView=new Set(a.userCustomView.keys()),s.card=new Set(a.card.keys()),s.tag=new Set(a.tag.keys()),s.myDayEntry=new Set(a.myDayEntry.keys()),s.user=new Set(a.user.keys()),s.groceryBoard=new Set(a.groceryBoard.keys()),s.grocerySection=new Set(a.grocerySection.keys()),s.groceryCard=new Set(a.groceryCard.keys()),s.cardChecklist=new Set(a.cardChecklist.keys()),s.checklistItem=new Set(a.checklistItem.keys()),s.cardAttachment=new Set(a.cardAttachment.keys())),Xe.forEach(n=>{const c=t.models[n.name];if(c.statusCode!==Ze)throw new Error(`processSyncResponseDtos(): Shouldn't be called when sync response status is \`${c.statusCode}\` for '${n.name}'`);for(let d of c.items){const u=n.getDtoId(d),h=e?void 0:a[n.name].get(u),_=qs(n.name,n.mapDtoToModel(d,h,t));e&&s[n.name].delete(_.id),n.shouldRemoveModelFromStore(_,t)?(s[n.name].add(_.id),r[n.name].delete(_.id)):s[n.name].has(_.id)||r[n.name].set(_.id,_)}if(e)return;const l=n.fieldsConfiguration;if(l!=null)for(let d of r[n.name].values()){let u=a[n.name].get(d.id);if(u!=null){for(let h of l)if(h.syncCounter!=null){const{field:_,syncCounter:V,updateTime:R}=h,L=u[_],G=d[_],H=u[R],$=d[R],j=u[V];js({localValue:L,remoteValue:G,localUpdateTime:H,remoteUpdateTime:$,localSyncCounter:j,syncId:t.syncId})&&(d[_]=L,d.dirty=1),d[V]=j}n.name==="task"&&(d.deleted=u.deleted)}}}),{deletions:s,updates:r,lastUpdateDate:t.lastUpdateDate}}function qs(a,t){switch(a){case"attachment":return new ge(t);case"category":return new pe(t);case"label":return new fe(t);case"task":return new Te(t);case"space":return new ut(t);case"board":return new Ee(t);case"section":return new ke(t);case"userCustomView":return new yt(t);case"card":return new Ie(t);case"tag":return new Ce(t);case"myDayEntry":return new we(t);case"user":return new be(t);case"groceryBoard":return new Ae(t);case"grocerySection":return new at(t);case"groceryCard":return new tt(t);case"cardChecklist":return new mt(t);case"checklistItem":return new _t(t);case"cardAttachment":return new St(t);default:throw new Error(`cloneModel(): Doesn't support "${a}" type`)}}function js({localValue:a,remoteValue:t,localUpdateTime:e,remoteUpdateTime:r,localSyncCounter:s,syncId:n}){return a===t||Ss(a,t)?!1:e!=null&&e!==0&&r!=null&&e===r?!0:n==null?!1:s!=null&&s>=n}const zs=500,Zs=5e3,Xs=3e4;class Qs{constructor({HttpAdapter:t,WebSocketAdapter:e,INITIALIZE_NOW:r,auth:s,isApplicationActive:n,getClientId:c,events:l=new Pt,store:d=new Ws}){i(this,"_updateVersion",0);i(this,"_INITIALIZE_NOW");i(this,"_auth");i(this,"_events");i(this,"_store");i(this,"_httpAdapter");i(this,"_webSocketAdapter");i(this,"_offs",[]);i(this,"_timeoutSync");i(this,"_trackFirstServerSyncStart");i(this,"_dirtinessReSyncCounter",0);i(this,"_connectivityChangeLastArgs",{isOnline:!0});i(this,"_canOverlapSync",!1);i(this,"_syncDebounced",Y(({isRecoverySync:t,allowEmpty:e})=>{if(!this._auth.isLoggedIn()||!this._canSync())return;this._setSyncingIsStarted(),this._triggerConnectivityChange();const r=this._webSocketAdapter.canTryToConnect()?this._webSocketAdapter:this._httpAdapter;O.trackRequest({adapterType:r.type,isRecoverySync:t,allowEmpty:e,previousSyncId:this._store.lastServerSyncId,previousLastUpdateDate:this._store.lastUpdateDate}),t?r.recoverySync():r.sync({allowEmpty:e,isFirstSync:this._store.isFirstSync})},zs));i(this,"_handleFetch",t=>{O.trackResponse({clientSyncCounter:this._store.clientSyncCounter,event:t});const{isFirstSync:e}=this._store;this._setSyncingIsStopped(),this._triggerConnectivityChange({isOnline:!0});const r=t.response.syncId;let s;if((t.isRecoverySync||r==null||this._store.lastServerSyncId<r)&&(s=Ys({store:this._store,syncResponseDtos:t.response,isRecoverySync:t.isRecoverySync}),Ks({processedSyncResponse:s,store:this._store,serverSyncId:r})),this._store.isDirty()?(this._dirtinessReSyncCounter++,this.sync()):this._dirtinessReSyncCounter=0,this._dirtinessReSyncCounter===20&&F("Infinity sync seems to be happend","SyncBase#_handleFetch"),e){const n=lt(this._INITIALIZE_NOW)-this._trackFirstServerSyncStart;this._events.emitAsap("first-sync",{type:"first-sync",duration:n})}s!=null&&this._events.emit("sync",{type:"sync",updateVersion:this._getIncrementUpdateVersion(),config:{shouldReset:e||t.isRecoverySync},deletions:{attachment:s.deletions.attachment,category:s.deletions.category,label:s.deletions.label,task:s.deletions.task,space:s.deletions.space,board:s.deletions.board,section:s.deletions.section,userCustomView:s.deletions.userCustomView,card:s.deletions.card,tag:s.deletions.tag,myDayEntry:s.deletions.myDayEntry,user:s.deletions.user,groceryBoard:s.deletions.groceryBoard,grocerySection:s.deletions.grocerySection,groceryCard:s.deletions.groceryCard,cardChecklist:s.deletions.cardChecklist,checklistItem:s.deletions.checklistItem,cardAttachment:s.deletions.cardAttachment},updates:{attachment:new Set(s.updates.attachment.keys()),category:new Set(s.updates.category.keys()),label:new Set(s.updates.label.keys()),task:new Set(s.updates.task.keys()),space:new Set(s.updates.space.keys()),board:new Set(s.updates.board.keys()),section:new Set(s.updates.section.keys()),userCustomView:new Set(s.updates.userCustomView.keys()),card:new Set(s.updates.card.keys()),tag:new Set(s.updates.tag.keys()),myDayEntry:new Set(s.updates.myDayEntry.keys()),user:new Set(s.updates.user.keys()),groceryBoard:new Set(s.updates.groceryBoard.keys()),grocerySection:new Set(s.updates.grocerySection.keys()),groceryCard:new Set(s.updates.groceryCard.keys()),cardChecklist:new Set(s.updates.cardChecklist.keys()),checklistItem:new Set(s.updates.checklistItem.keys()),cardAttachment:new Set(s.updates.cardAttachment.keys())}})});i(this,"_handleError",t=>{switch(this._dirtinessReSyncCounter=0,t.status===y.NEEDS_HTTP_FALLBACK?O.trackFallback({clientSyncCounter:this._store.clientSyncCounter}):O.trackResponseError({clientSyncCounter:this._store.clientSyncCounter,error:t}),this._setSyncingIsStopped(),t.status!==y.NETWORK_UNAVAILABLE&&this._triggerConnectivityChange({isOnline:!0}),t.status){case y.UNAUTHORIZED:this._auth.logout();break;case y.RESPONSE_ERROR:this._sync({isRecoverySync:!0});break;case y.NEEDS_HTTP_FALLBACK:this._sync(t.syncOptions);break;case y.WEB_SOCKET_FAILURE:this._sync({allowEmpty:!0});break;case y.TIMEOUT:this._timeoutSync(t.syncOptions);break;case y.INTERNAL_SERVER_ERROR:this._timeoutSync({allowEmpty:!1,isRecoverySync:!1});break;case y.NETWORK_UNAVAILABLE:this._triggerConnectivityChange({isOnline:!1});break;case y.ABORT:case y.BAD_REQUEST:case y.LOGGED_OUT:case y.UNKNOWN_ERROR:break}});i(this,"_handleTimeout",t=>{this._sync(t)});i(this,"_handleSignedIn",()=>{this._store.reset(),this._trackFirstServerSyncStart=lt(this._INITIALIZE_NOW),this._updateAdaptersAuthToken(),this._sync({allowEmpty:!0})});i(this,"_handleSignedOut",()=>{this._store.reset(),this._syncDebounced.cancel(),this._webSocketAdapter.setApplicationIsDeactivated(),this._timeoutSync.cancel(),this._updateAdaptersAuthToken()});i(this,"_allowOverlapsSyncing",Y(()=>{this._canOverlapSync=!0},Xs));O.INITIALIZE_NOW=r,this._INITIALIZE_NOW=r,this._trackFirstServerSyncStart=lt(r),this._store=d,this._timeoutSync=Y(this._handleTimeout,Zs),this._auth=s,this._events=l;const u=this._store.lastUpdateDate!==0,h=()=>this._updateAndGetNextClientSyncCounter();if(this._httpAdapter=new t({authToken:this._auth.getAuthToken(),isApplicationActive:n,store:this._store,updateAndGetNextClientSyncCounter:h,getClientId:c}),this._webSocketAdapter=new e({authToken:this._auth.getAuthToken(),isApplicationActive:u,store:this._store,updateAndGetNextClientSyncCounter:h,getClientId:c}),this._offs.push(this._auth.subscribe("loggedIn",this._handleSignedIn)),this._offs.push(this._auth.subscribe("loggedOut",this._handleSignedOut)),this._offs.push(this._httpAdapter.onFetch(this._handleFetch)),this._offs.push(this._webSocketAdapter.onFetch(this._handleFetch)),this._offs.push(this._httpAdapter.onError(this._handleError)),this._offs.push(this._webSocketAdapter.onError(this._handleError)),!u){const _=this.on("first-sync",()=>{this._webSocketAdapter.setApplicationIsActiveted()});this._offs.push(_)}this.sync({allowEmpty:!0,withoutActivate:!u})}_getIncrementUpdateVersion(){return this._updateVersion+=1,this._updateVersion}destroy(){let t;for(;t=this._offs.pop();)t();this._events.off(),this._store.reset(),this._syncDebounced.cancel(),this._timeoutSync.cancel(),this._httpAdapter.destroy(),this._webSocketAdapter.destroy(),this._allowOverlapsSyncing.cancel(),Object.assign(this,{_auth:null,_events:null,_httpAdapter:null,_webSocketAdapter:null,_store:null})}_setApplicationIsActiveted(){this._httpAdapter.setApplicationIsActiveted(),this._webSocketAdapter.setApplicationIsActiveted()}setApplicationIsActiveted(){this._setApplicationIsActiveted(),this.isSyncing()||this.sync({allowEmpty:!0})}setApplicationIsDeactivated(){this._timeoutSync.cancel(),this._httpAdapter.setApplicationIsDeactivated(),this._webSocketAdapter.setApplicationIsDeactivated()}lastUpdateDate(){return this._store.lastUpdateDate}isSyncing(){return this._store.isSyncing}isDirty(){return this._store.isDirty()}read(){return{updateVersion:this._updateVersion,clientSyncCounter:this._store.clientSyncCounter,lastUpdateDate:this._store.lastUpdateDate,attachment:this._store.attachment,category:this._store.category,label:this._store.label,task:this._store.task,space:this._store.space,board:this._store.board,section:this._store.section,userCustomView:this._store.userCustomView,card:this._store.card,tag:this._store.tag,user:this._store.user,myDayEntry:this._store.myDayEntry,groceryBoard:this._store.groceryBoard,grocerySection:this._store.grocerySection,groceryCard:this._store.groceryCard,cardChecklist:this._store.cardChecklist,checklistItem:this._store.checklistItem,cardAttachment:this._store.cardAttachment,categoriesUncheckedTaskIds:this._store.categoriesUncheckedTaskIds,boardsSectionIds:this._store.boardsSectionIds,sectionsCardIds:this._store.sectionsCardIds,boardsTeamsTagIds:this._store.boardsTeamsTagIds,tasksMyDayEntryIds:this._store.tasksMyDayEntryIds,tasksAttachmentsIds:this._store.tasksAttachmentsIds,tasksCheckedSubTasksIds:this._store.tasksCheckedSubTasksIds,tasksUncheckedSubTasksIds:this._store.tasksUncheckedSubTasksIds,groceryBoardsSectionIds:this._store.groceryBoardsSectionIds,grocerySectionsCardIds:this._store.grocerySectionsCardIds}}on(t,e){return this._events.on(t,e),()=>this._events.off(t,e)}_updateAdaptersAuthToken(){const t=this._auth.getAuthToken();this._httpAdapter.setAuthToken(t),this._webSocketAdapter.setAuthToken(t)}_updateAndGetNextClientSyncCounter(){return this._store.clientSyncCounter=this._store.clientSyncCounter+1,this._store.clientSyncCounter}_sync({isRecoverySync:t=!1,allowEmpty:e=t}={}){this._auth.isLoggedIn()&&this._canSync()&&(this._timeoutSync.cancel(),this._syncDebounced({isRecoverySync:t,allowEmpty:e}),(t||e)&&this._syncDebounced.flush())}isAfterFirstSync(){return!this._store.isFirstSync}sync({allowEmpty:t=!1,withoutActivate:e=!1}={}){e||this._setApplicationIsActiveted(),this._sync({allowEmpty:t})}syncWithoutActivate(){this.sync({allowEmpty:!0,withoutActivate:!0})}forceReset(){this._store.reset(),this._syncDebounced.cancel(),this._webSocketAdapter.setApplicationIsDeactivated(),this._timeoutSync.cancel(),this._updateAdaptersAuthToken(),this._trackFirstServerSyncStart=lt(this._INITIALIZE_NOW),this._updateAdaptersAuthToken(),this._sync({allowEmpty:!0})}update(t){if(t.attachment)for(let e of t.attachment)this._store.set("attachment",e);if(t.category)for(let e of t.category)this._store.set("category",e);if(t.label)for(let e of t.label)this._store.set("label",e);if(t.task)for(let e of t.task)this._store.set("task",e);if(t.space)for(let e of t.space)this._store.set("space",e);if(t.board)for(let e of t.board)this._store.set("board",e);if(t.section)for(let e of t.section)this._store.set("section",e);if(t.userCustomView)for(let e of t.userCustomView)this._store.set("userCustomView",e);if(t.card)for(let e of t.card)this._store.set("card",e);if(t.tag)for(let e of t.tag)this._store.set("tag",e);if(t.myDayEntry)for(let e of t.myDayEntry)this._store.set("myDayEntry",e);if(t.user)for(let e of t.user)this._store.set("user",e);if(t.groceryBoard)for(let e of t.groceryBoard)this._store.set("groceryBoard",e);if(t.grocerySection)for(let e of t.grocerySection)this._store.set("grocerySection",e);if(t.groceryCard)for(let e of t.groceryCard)this._store.set("groceryCard",e);if(t.cardChecklist)for(let e of t.cardChecklist)this._store.set("cardChecklist",e);if(t.checklistItem)for(let e of t.checklistItem)this._store.set("checklistItem",e);if(t.cardAttachment)for(let e of t.cardAttachment)this._store.set("cardAttachment",e);if(this._store.isDirty()){if(this._events.countListeners("will-update")){const e=this._store.getAllDirtyIds();this._events.emit("will-update",{type:"will-update",updateVersion:this._getIncrementUpdateVersion(),attachment:w(this._store.attachment,e.attachment),category:w(this._store.category,e.category),label:w(this._store.label,e.label),task:w(this._store.task,e.task),space:w(this._store.space,e.space),board:w(this._store.board,e.board),section:w(this._store.section,e.section),userCustomView:w(this._store.userCustomView,e.userCustomView),card:w(this._store.card,e.card),tag:w(this._store.tag,e.tag),myDayEntry:w(this._store.myDayEntry,e.myDayEntry),user:w(this._store.user,e.user),groceryBoard:w(this._store.groceryBoard,e.groceryBoard),grocerySection:w(this._store.grocerySection,e.grocerySection),groceryCard:w(this._store.groceryCard,e.groceryCard),cardChecklist:w(this._store.cardChecklist,e.cardChecklist),checklistItem:w(this._store.checklistItem,e.checklistItem),cardAttachment:w(this._store.cardAttachment,e.cardAttachment)})}this.sync()}}_triggerConnectivityChange({isOnline:t=this._connectivityChangeLastArgs.isOnline}={}){this._events.emit("connectivity-change",{type:"connectivity-change",isSyncing:this.isSyncing(),isOnline:t,lastUpdate:this._store.lastUpdateDate})}_canSync(){return!this._store.isSyncing||this._canOverlapSync}_setSyncingIsStarted(){this._canOverlapSync=!1,this._store.isSyncing=!0,this._allowOverlapsSyncing()}_setSyncingIsStopped(){this._allowOverlapsSyncing.cancel(),this._canOverlapSync=!1,this._store.isSyncing=!1}}function lt(a){return typeof performance>"u"?Date.now()-a:performance.now()}function w(a,t){const e=new Map;for(let r of t){const s=a.get(r);s!=null&&e.set(s.id,s)}return e}function Qe({store:a,syncId:t,isFirstSync:e,isRecoverySync:r}){const s=a.getAllDirtyIds();return{syncId:t,models:{attachment:A({dirtyModelsIds:s.attachment,models:a.attachment,syncLogic:Ne,isFirstSync:e,isRecoverySync:r}),category:A({dirtyModelsIds:s.category,models:a.category,syncLogic:ve,isFirstSync:e,isRecoverySync:r}),label:A({dirtyModelsIds:s.label,models:a.label,syncLogic:Ue,isFirstSync:e,isRecoverySync:r}),task:A({dirtyModelsIds:s.task,models:a.task,syncLogic:Me,isFirstSync:e,isRecoverySync:r}),space:A({dirtyModelsIds:s.space,models:a.space,syncLogic:Le,isFirstSync:e,isRecoverySync:r}),board:A({dirtyModelsIds:s.board,models:a.board,syncLogic:Oe,isFirstSync:e,isRecoverySync:r}),section:A({dirtyModelsIds:s.section,models:a.section,syncLogic:Re,isFirstSync:e,isRecoverySync:r}),userCustomView:A({dirtyModelsIds:s.userCustomView,models:a.userCustomView,syncLogic:Fe,isFirstSync:e,isRecoverySync:r}),card:A({dirtyModelsIds:s.card,models:a.card,syncLogic:Be,isFirstSync:e,isRecoverySync:r}),tag:A({dirtyModelsIds:s.tag,models:a.tag,syncLogic:Pe,isFirstSync:e,isRecoverySync:r}),myDayEntry:A({dirtyModelsIds:s.myDayEntry,models:a.myDayEntry,syncLogic:We,isFirstSync:e,isRecoverySync:r}),user:A({dirtyModelsIds:s.user,models:a.user,syncLogic:Ve,isFirstSync:e,isRecoverySync:r}),groceryBoard:A({dirtyModelsIds:s.groceryBoard,models:a.groceryBoard,syncLogic:Ge,isFirstSync:e,isRecoverySync:r}),grocerySection:A({dirtyModelsIds:s.grocerySection,models:a.grocerySection,syncLogic:xe,isFirstSync:e,isRecoverySync:r}),groceryCard:A({dirtyModelsIds:s.groceryCard,models:a.groceryCard,syncLogic:He,isFirstSync:e,isRecoverySync:r}),cardChecklist:A({dirtyModelsIds:s.cardChecklist,models:a.cardChecklist,syncLogic:$e,isFirstSync:e,isRecoverySync:r}),checklistItem:A({dirtyModelsIds:s.checklistItem,models:a.checklistItem,syncLogic:Ke,isFirstSync:e,isRecoverySync:r}),cardAttachment:A({dirtyModelsIds:s.cardAttachment,models:a.cardAttachment,syncLogic:Ye,isFirstSync:e,isRecoverySync:r})}}}function A({models:a,dirtyModelsIds:t,syncLogic:e,isFirstSync:r,isRecoverySync:s}){const n=e.getSyncConfiguration==null?void 0:e.getSyncConfiguration({isFirstSync:r,isRecoverySync:s}),c=[];return s||t.forEach(l=>{const d=a.get(l);if(d==null)F(`id of "${l}" of doesn't exist in "${e.name}"`,"prepareSyncRequestDtos() - getSyncRequestDtoModel()");else{const u=e.mapModelToDto(d);c.push(u)}}),{items:c,config:n}}function Je(a){return a.models.category.items.length===0&&a.models.task.items.length===0&&a.models.attachment.items.length===0&&a.models.label.items.length===0&&a.models.space.items.length===0&&a.models.board.items.length===0&&a.models.section.items.length===0&&a.models.userCustomView.items.length===0&&a.models.card.items.length===0&&a.models.tag.items.length===0&&a.models.myDayEntry.items.length===0&&a.models.user.items.length===0&&a.models.groceryBoard.items.length===0&&a.models.grocerySection.items.length&&a.models.groceryCard.items.length===0&&a.models.cardChecklist.items.length===0&&a.models.checklistItem.items.length&&a.models.cardAttachment.items.length===0}function ts(a){return a!=null&&a.models!=null&&Xe.every(t=>a.models[t.name]!=null&&a.models[t.name].statusCode===Ze)}function Js(a){const t=Number.isNaN(a)||a<0?0:a,e=t!==0,r=new URL(fs);return r.search="?"+new URLSearchParams([["updatedSince",t.toString(10)],["includeNonVisible",e.toString()]]).toString(),r.toString()}function ta(a){return`${ps}/${a}`}function ea(a){const t=Number.isNaN(a)||a<0?0:a,e=t!==0,r=new URL(gs);return r.search="?"+new URLSearchParams([["updatedSince",t.toString(10)],["includeNonVisible",e.toString()]]).toString(),r.toString()}const es="HTTP";class sa{constructor({store:t,authToken:e,updateAndGetNextClientSyncCounter:r}){i(this,"type",es);i(this,"_store");i(this,"_events",new Pt);i(this,"_updateAndGetNextClientSyncCounter");i(this,"_authToken",null);i(this,"_abortController",null);this._store=t,this._authToken=e,this._updateAndGetNextClientSyncCounter=r}destroy(){this._events.off(),this._abortController!=null&&(this._abortController.abort(),this._abortController=null),this._authToken=null,this._events=void 0,this._store=void 0,this._sync=void 0}async _sync({isFirstSync:t,allowEmpty:e,isRecoverySync:r}){this._abortController!=null&&(this._abortController.abort(),this._abortController=null);const s=this._authToken;let n=this._store.lastUpdateDate;if(r&&(n=0,e=!0),s==null){this._events.emit("error",Ut(y.LOGGED_OUT));return}const c=this._updateAndGetNextClientSyncCounter(),l=Qe({syncId:c,store:this._store,isFirstSync:t,isRecoverySync:r});if(!r&&!e&&Je(l))return;const d=typeof AbortController>"u"?null:new AbortController;this._abortController=d;let u;if(t?u=await na({authToken:s,abortController:d,lastUpdateDate:n}):u=await ia({authToken:s,abortController:d,dtos:l,lastUpdateDate:n}),s===this._authToken&&!(d!=null&&d.signal.aborted))if(u.error==null){const h=u.data;ts(h)?this._events.emit("fetch",{type:"fetch",adapterType:this.type,response:h,isRecoverySync:r}):this._events.emit("error",Ut(y.RESPONSE_ERROR))}else u.error===y.NEEDS_HTTP_FALLBACK?F("Shouldn't emit NEEDS_HTTP_FALLBACK","HttpSyncAdapter#_sync()"):u.error===y.TIMEOUT?this._events.emit("error",{type:"error",adapterType:this.type,status:y.TIMEOUT,syncOptions:{allowEmpty:e,isRecoverySync:r}}):this._events.emit("error",Ut(u.error))}setApplicationIsActiveted(){}setApplicationIsDeactivated(){}canTryToConnect(){return!0}close(){this._abortController!=null&&(this._abortController.abort(),this._abortController=null)}setAuthToken(t){this._authToken=t,this._abortController!=null&&(this._abortController.abort(),this._abortController=null)}sync(t){this._sync({...t,isRecoverySync:!1})}syncLastUpdateDate(){}recoverySync(){this._sync({allowEmpty:!0,isFirstSync:!1,isRecoverySync:!0})}onFetch(t){return this._events.on("fetch",t),()=>this._events.off("fetch",t)}onError(t){return this._events.on("error",t),()=>this._events.off("error",t)}}function Ut(a){return{type:"error",adapterType:es,status:a}}async function aa(a){const{taskId:t,abortController:e,authToken:r}=a,s=ta(t),n=setTimeout(()=>{e!=null&&e.abort()},Ot);e!=null&&e.signal.addEventListener("abort",()=>{clearTimeout(n)});const c=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8",[Rt]:r,...Ft()},signal:e==null?void 0:e.signal});return clearTimeout(n),c}async function ra(a){const{interval:t,timeout:e}=a,r=Date.now(),s=()=>Date.now()-r>e*1e3,n=(c,l)=>{aa(a).then(d=>{switch(d.status){case 404:if(s()){const h=q({source:"pollBackgroundSyncResultEndpoint",error:new Error(`timed out after ${e} seconds`)});l(h)}else setTimeout(n,t*1e3,c,l);break;case 200:c(d);break;default:const u=q({status:d.status,source:"pollBackgroundSyncResultEndpoint"});l(u)}}).catch(d=>{const u=q({error:new Error(d),source:"pollBackgroundSyncResultEndpoint"});l(u)})};return new Promise(n)}function q({status:a,error:t,source:e}){if((t==null?void 0:t.name)==="AbortError")return x(y.ABORT);if(a){if(a===0)return x(y.NETWORK_UNAVAILABLE);if(a===400)return x(y.BAD_REQUEST);if(a>=401&&a<500)return x(y.UNAUTHORIZED);if(a>=500)return x(y.INTERNAL_SERVER_ERROR)}return F(t,`SyncHttpAdapter - ${e}()`),x(y.UNKNOWN_ERROR)}async function ia({authToken:a,dtos:t,lastUpdateDate:e,abortController:r}){try{const s=ea(e);let n;const c=setTimeout(()=>{r!=null&&r.abort()},Ot);r!=null&&r.signal.addEventListener("abort",()=>{clearTimeout(c)});try{n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8",[Rt]:a,...Ft()},body:JSON.stringify(t),signal:r==null?void 0:r.signal}),clearTimeout(c)}catch{return x(y.NETWORK_UNAVAILABLE)}return n.ok?{data:await n.json(),error:null}:q({status:n.status,source:"callSyncEndpoint"})}catch(s){return q({error:s,source:"callSyncEndpoint"})}}async function na({authToken:a,lastUpdateDate:t,abortController:e}){try{const r=Js(t);let s;const n=setTimeout(()=>{e!=null&&e.abort()},Ot);e!=null&&e.signal.addEventListener("abort",()=>{clearTimeout(n)});try{s=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8",[Rt]:a,...Ft()},signal:e==null?void 0:e.signal}),clearTimeout(n)}catch{return x(y.NETWORK_UNAVAILABLE)}if(s.ok){const{task_id:c,polling_interval:l,total_timeout:d}=await s.json();try{if(Es.type===ks.WEB_EXTENSION&&await new Promise(u=>setTimeout(u,250)),s=await ra({taskId:c,interval:l,timeout:d,authToken:a,abortController:e}),s.ok)return{data:await s.json(),error:null}}catch(u){return u}}return q({status:s.status,source:"callSyncEndpoint"})}catch(r){return q({error:r,source:"callBackgroundSyncEndpoint"})}}function x(a){return{data:null,error:a}}var P=(a=>(a.PING="ping",a.AUTHENTICATE="authenticate",a.SYNC_UPDATE_OR_CREATE="syncUpdateOrCreate",a.SET_LAST_UPDATE_DATE="setLastUpdateDate",a.RECOVERY_SYNC_REQUEST="recoverySyncReq",a))(P||{}),K=(a=>(a.PONG="pong",a.SYNC_FETCH="syncFetch",a.AUTH_FAILED="authFailed",a.RECOVERY_SYNC="recoverySync",a.AUTH_SUCCESS="authSuccess",a.ERROR="error",a))(K||{});function vt(a){return a==null||a===-1||a===0}const oa=1e3,ca=1024*32;class la{constructor({WebSocket:t,url:e,onMessage:r,onOpen:s,onClose:n,onError:c}){i(this,"_ws");i(this,"_WS_STATUS_OPEN");i(this,"_onMessage");i(this,"_off");i(this,"_handleMessage",t=>{const e=JSON.parse(t.data);this._onMessage(e)});this._WS_STATUS_OPEN=t.OPEN;const l=new t(e);l.binaryType="blob",l.addEventListener("open",s,!1),l.addEventListener("message",this._handleMessage,!1),l.addEventListener("close",n,!1),l.addEventListener("error",c,!1),this._ws=l,this._onMessage=r,this._off=()=>{this._ws.removeEventListener("open",s,!1),this._ws.removeEventListener("message",this._handleMessage,!1),this._ws.removeEventListener("close",n,!1),this._ws.removeEventListener("error",c,!1)}}destroy(){try{this.isConnected()&&this._ws.close(oa,"closed by client")}catch(t){console.info(`SyncWebSocket#destroy(): error:
${t.message}`),ot.addBreadcrumb({level:"error",category:"ws/destroy",message:`SyncWebSocket#destroy(): error:
${t.message}`}),ot.captureException(t)}finally{this._off()}Object.assign({_off:null,_onMessage:null})}send(t){if(this.isConnected())try{const e=JSON.stringify(t);if(e.length>=ca)return{didPassSizeLimit:!0};this._ws.send(e)}catch(e){throw console.info(`SyncWebSocket#send(): error:
${e.message}
${e.info}`),ot.addBreadcrumb({level:"error",category:"ws/send",message:`SyncWebSocket#send(): error:
${e.message}
${e.info}`}),ot.captureException(e),e}else throw new Error("SyncWebSocket#send(): Try to send when not connected");return{didPassSizeLimit:!1}}isConnected(){return this.getReadyState()===this._WS_STATUS_OPEN}getReadyState(){return this._ws.readyState}}const re=12e4,da=1e3*30;class ss{constructor({isDisabled:t=!1,WebSocket:e,store:r,authToken:s,isApplicationActive:n,getClientId:c,updateAndGetNextClientSyncCounter:l}){i(this,"type","WebSocket");i(this,"_events",new Pt);i(this,"_store");i(this,"_updateAndGetNextClientSyncCounter");i(this,"_timeout");i(this,"_getClientId");i(this,"_authToken",null);i(this,"_ws",null);i(this,"_isAuthenticating",!1);i(this,"_isApplicationActive");i(this,"_disabled");i(this,"_lastUpdateDateSent",Number.MIN_SAFE_INTEGER);i(this,"_hasSyncStarted",!1);i(this,"_isHttpFallbackForced",!1);i(this,"_WebSocket");i(this,"_WS_STATUS_CONNECTING",0);i(this,"_WS_STATUS_OPEN",1);i(this,"_WS_STATUS_CLOSING",2);i(this,"_WS_STATUS_CLOSED",3);i(this,"_resetWebSocketIfNeededDebounced",Y(()=>{this._resetWebSocketIfNeeded()},da));i(this,"_stopHttpFallbackDebounced",Y(()=>{this._isHttpFallbackForced=!1,this._resetWebSocketIfNeeded()},re));i(this,"_handleWsOpen",()=>{O.trackWebSocketStatus({status:"open"}),this._timeout.cancel();const t=this._authToken;t==null?this._clearWebSocket():(this._isAuthenticating=!0,this._wsSend({type:P.AUTHENTICATE,authToken:t,apiVersion:Ts,clientId:this._getClientId(),platform:ws(),lastUpdateDate:this._store.lastUpdateDate}))});i(this,"_handleWsClose",t=>{O.trackWebSocketStatus({status:"close",code:`${t.code}:"${t.reason}"`}),this._resetWebSocketIfNeededDebounced(),this._hasSyncStarted&&(this._hasSyncStarted=!1,this._events.emit("error",{type:"error",adapterType:this.type,status:y.NEEDS_HTTP_FALLBACK,syncOptions:{allowEmpty:!0,isFirstSync:!1,isRecoverySync:!1}}))});i(this,"_handleWsError",t=>{this._hasSyncStarted=!1,O.trackWebSocketStatus({status:"error"}),F(t,"WebSocketSyncAdapterConnection#_handleError()")});i(this,"_handleWsMessage",t=>{switch(this._hasSyncStarted=!1,this._timeout.cancel(),O.trackWebSocketStatus({status:"message"}),t.type){case K.PONG:break;case K.RECOVERY_SYNC:this._events.emit("fetch",{type:"fetch",adapterType:this.type,response:t.syncResponseDto,isRecoverySync:!0});break;case K.SYNC_FETCH:this._emitMessageSyncFetch(t);break;case K.AUTH_FAILED:this._events.emit("error",{type:"error",adapterType:this.type,status:y.UNAUTHORIZED});break;case K.AUTH_SUCCESS:this._isAuthenticating=!1;break;case K.ERROR:this._forceHttpFallbackTemporary();break;case void 0:F(t,"WebSocketSyncAdapter.ts"),this._forceHttpFallbackTemporary();break;default:F(`Unknown message.type "${t.type}"`,"WebSocketSyncAdapter.ts")}});i(this,"_handleTimeout",t=>{this._hasSyncStarted=!1,this._resetWebSocket(),this._events.emit("error",{type:"error",adapterType:this.type,status:y.TIMEOUT,syncOptions:t})});this._disabled=Is||t,this._WebSocket=e,this._WebSocket!=null&&(this._WS_STATUS_CONNECTING=this._WebSocket.CONNECTING,this._WS_STATUS_OPEN=this._WebSocket.OPEN,this._WS_STATUS_CLOSING=this._WebSocket.CLOSING,this._WS_STATUS_CLOSED=this._WebSocket.CLOSED),this._isApplicationActive=n,this._authToken=s,this._store=r,this._getClientId=c,this._updateAndGetNextClientSyncCounter=l,this._timeout=Y(this._handleTimeout,Cs),!this._isDisabled()&&this._isApplicationActive&&this._resetWebSocket()}destroy(){var t;this._timeout.cancel(),this._stopHttpFallbackDebounced.cancel(),this._resetWebSocketIfNeededDebounced.cancel(),(t=this._ws)==null||t.destroy(),this._events.off(),this._isDisabled()||this._clearWebSocket(),this._authToken=null,Object.assign(this,Object.fromEntries(Object.entries(this).map(([e])=>[e,null])))}setApplicationIsActiveted(){this._isDisabled()||this._isApplicationActive||(this._isApplicationActive=!0,O.trackWebSocketStatus({status:"app active"}),this._resetWebSocketIfNeeded())}setApplicationIsDeactivated(){this._isDisabled()||this._isApplicationActive&&(this._isApplicationActive=!1,O.trackWebSocketStatus({status:"app inactive"}),this._clearWebSocket())}canTryToConnect(){return this._isDisabled()||this._shouldHttpFallback()||this._ws==null||this._isAuthenticating?!1:this._ws.getReadyState()===this._WS_STATUS_OPEN}close(){this._isDisabled()||this._clearWebSocket()}setAuthToken(t){if(this._isDisabled())return;this._stopHttpFallbackWithoutSideEffects();const e=this._isUserLoggedIn();this._authToken=t;const r=this._isUserLoggedIn();e!==r&&(r?this._isApplicationActive&&this._resetWebSocket():this._clearWebSocket())}syncLastUpdateDate(){this.canTryToConnect()&&this._authToken!=null&&this._store.lastUpdateDate>this._lastUpdateDateSent&&this._wsSend({type:P.SET_LAST_UPDATE_DATE,authToken:this._authToken,lastUpdateDate:this._store.lastUpdateDate})}sync(t){this._isDisabled()||this._sync({...t,isRecoverySync:!1})}recoverySync(){this._forceHttpFallbackTemporary(!0)}onFetch(t){return this._events.on("fetch",t),()=>this._events.off("fetch",t)}onError(t){return this._events.on("error",t),()=>this._events.off("error",t)}async _sync(t){this._isUserLoggedIn()&&(this._ws!=null&&this._ws.isConnected()?this._sendSyncUpdateOrCreateMessage(t):((this._ws==null||this._ws.getReadyState()!==this._WS_STATUS_CONNECTING)&&this._resetWebSocket(),this._events.emit("error",{type:"error",adapterType:this.type,status:y.NEEDS_HTTP_FALLBACK,syncOptions:t})))}_isUserLoggedIn(){return!!this._authToken}_clearWebSocket(){this._timeout.cancel(),this._resetWebSocketIfNeededDebounced.cancel(),this._ws!=null&&(this._ws.destroy(),this._ws=null)}_resetWebSocket(){this._clearWebSocket(),!this._isDisabled()&&this._isUserLoggedIn()&&(this._ws=new la({WebSocket:this._WebSocket,url:bs,onClose:this._handleWsClose,onError:this._handleWsError,onMessage:this._handleWsMessage,onOpen:this._handleWsOpen}))}_resetWebSocketIfNeeded(){this._resetWebSocketIfNeededDebounced.cancel(),(this._ws==null||this._ws.getReadyState()===this._WS_STATUS_CLOSING||this._ws.getReadyState()===this._WS_STATUS_CLOSED)&&this._resetWebSocket()}_shouldHttpFallback(){return this._isHttpFallbackForced}_stopHttpFallbackWithoutSideEffects(){this._isHttpFallbackForced=!1}_forceHttpFallbackTemporary(t=!1){this._isHttpFallbackForced=!0,this._clearWebSocket(),this._stopHttpFallbackDebounced(),this._events.emit("error",{type:"error",adapterType:this.type,status:y.NEEDS_HTTP_FALLBACK,syncOptions:{allowEmpty:!0,isFirstSync:!1,isRecoverySync:t}}),t&&this._stopHttpFallbackDebounced.flush()}_emitMessageSyncFetch(t){if(!ts(t.syncResponseDto)){this._events.emit("error",{type:"error",adapterType:this.type,status:y.RESPONSE_ERROR});return}ha({clientLastUpdateDate:this._store.lastUpdateDate,serverPrevLastUpdateDate:t.prevLastUpdateDate})?this._events.emit("fetch",{type:"fetch",adapterType:this.type,response:t.syncResponseDto,isRecoverySync:!1}):this._sendSyncUpdateOrCreateMessage({allowEmpty:!0,isRecoverySync:!1,isFirstSync:!1})}_isDisabled(){return this._disabled}_wsSend(t){let e=!1;try{if(this._ws!=null){if(this._ws.send(t).didPassSizeLimit){"lastUpdateDate"in t&&(this._lastUpdateDateSent=t.lastUpdateDate),this._forceHttpFallbackTemporary();return}e=!0}}catch(r){F(r,"WebSocketSyncAdapter#_wsSend()")}if(!e)switch(t.type){case P.PING:return;case P.RECOVERY_SYNC_REQUEST:this._lastUpdateDateSent=Number.MIN_SAFE_INTEGER,this._forceHttpFallbackTemporary();return;case P.AUTHENTICATE:case P.SET_LAST_UPDATE_DATE:case P.SYNC_UPDATE_OR_CREATE:this._lastUpdateDateSent=t.lastUpdateDate,this._forceHttpFallbackTemporary()}}_sendSyncUpdateOrCreateMessage({isFirstSync:t,allowEmpty:e,isRecoverySync:r}){const s=this._updateAndGetNextClientSyncCounter(),n=Qe({syncId:s,store:this._store,isFirstSync:t,isRecoverySync:r});if(!(!e&&Je(n)&&!r)){if(this._hasSyncStarted=!0,t||this._timeout({allowEmpty:e,isRecoverySync:r}),r)throw new Error("WebSocketSyncAdapter#_sendSyncUpdateOrCreateMessage(): Cannot be used for recovery sync");{const c=this._authToken;this._wsSend({type:P.SYNC_UPDATE_OR_CREATE,authToken:c,lastUpdateDate:this._store.lastUpdateDate,syncRequestDto:n})}}}}i(ss,"FALLBACK_WAIT_MS",re);function ha({clientLastUpdateDate:a,serverPrevLastUpdateDate:t}){return vt(a)&&vt(t)?!0:vt(t)?!1:a==null||a>=t}class ua extends ss{constructor(t){super({...t,WebSocket:typeof WebSocket>"u"?void 0:WebSocket,isDisabled:typeof WebSocket>"u"})}}class Ra extends Qs{constructor({auth:t,isApplicationActive:e,getClientId:r,events:s,store:n}){super({HttpAdapter:sa,WebSocketAdapter:ua,INITIALIZE_NOW:_INITIALIZE_NOW_,auth:t,isApplicationActive:e,getClientId:r,events:s,store:n})}}const ie=1e3*30,st=class st{constructor({sync:t}){i(this,"_sync");i(this,"_isAppActive",st.isWindowActive());i(this,"_deactivate",Y(()=>{this._isAppActive&&(this._isAppActive=!1,this._sync.setApplicationIsDeactivated())},ie));i(this,"_handleVisibilityChange",()=>{this._update()});i(this,"_handleWindowFocus",()=>{this._update()});this._sync=t,window.addEventListener("focus",this._handleWindowFocus,{passive:!0}),document.addEventListener("visibilitychange",this._handleVisibilityChange,{passive:!0})}static isWindowActive(){return document.visibilityState==="visible"}destory(){window.removeEventListener("focus",this._handleWindowFocus),document.removeEventListener("visibilitychange",this._handleVisibilityChange)}_activate(){this._deactivate.cancel(),this._isAppActive||(this._isAppActive=!0,this._sync.setApplicationIsActiveted())}_update(){st.isWindowActive()?this._activate():this._deactivate()}};i(st,"APP_DEACTIVATE_DEBOUNCE",ie);let ne=st;const as=f.createContext(null);function Fa(){return f.useContext(as)}const ya=f.createContext(null),oe=[],ma=new Map,_a=M.memo(function({children:t,s3UploadManager:e}){const r=As(),[s,n]=M.useState(oe),[c,l]=M.useState(ma);pa(e,l),ga(e,l),ka(e,l),Ea(e,n,l);const d=Sa(r,e),u=fa(e),h=M.useCallback(R=>{u(R),l(L=>Wt(L,R))},[u]),_=M.useCallback(function(){n(oe),l(L=>{const G=new Map(L);return L.forEach((H,$)=>{H.error&&G.delete($)}),G})},[]),V=M.useMemo(()=>({attachmentsUploadErrors:s,attachmentsUploadStates:c,abortAttachmentUpload:h,uploadAttachments:d,resetAttachmentsUploadErrors:_,onUploadAttachmentComplete:e.subscribeDone}),[h,s,c,_,e.subscribeDone,d]);return W.jsx(ya.Provider,{value:V,children:t})});function Sa(a,t){return M.useCallback(function(r,s,n){t.uploadFiles(s,r,n),a.track("added_file_attachment",{extra_str1:r})},[a,t])}function fa(a){return M.useCallback(function(e){a.abortUpload(e)},[a])}function pa(a,t){M.useEffect(()=>a.subscribeDone(e=>{e.taskId!=null&&t(r=>Wt(r,e.fileId))}),[a,t])}function ga(a,t){M.useEffect(()=>a.subscribeProgress(e=>{t(r=>rs(r,e.fileId,new ft({taskId:e.taskId,fileId:e.fileId,progress:e.progress,originalFileName:e.originalFileName,error:!1})))}),[a,t])}function Ea(a,t,e){M.useEffect(()=>a.subscribeError(r=>{e(s=>r.fileId?rs(s,r.fileId,new ft({taskId:r.taskId,fileId:r.fileId,progress:0,originalFileName:r.originalFileName,error:!0})):s),t(s=>[...s,r])}),[a,t,e])}function ka(a,t){M.useEffect(()=>a.subscribeAbort(e=>{t(r=>Wt(r,e.fileId))}),[a,t])}function rs(a,t,e){if(a.get(t)===e)return a;const s=new Map(a);return s.set(t,e),s}function Wt(a,t){if(a.has(t)){const e=new Map(a);return e.delete(t),e}else return a}const Ia=f.createContext(null);function Ca({children:a,sync:t}){const e=dt(),r=Ta(t),s=f.useRef(!0),n=f.useCallback(()=>{t.sync({allowEmpty:!0})},[t]),c=f.useCallback(()=>r.current,[r]),l=f.useCallback(()=>s.current,[]),d=f.useCallback(()=>t.isSyncing(),[t]);f.useLayoutEffect(()=>t.on("connectivity-change",h=>{r.current=h.lastUpdate,s.current=h.isOnline,e.emit({lastUpdate:h.lastUpdate,isSyncing:h.isSyncing,isOnline:h.isOnline})}),[e,r,t]);const u=f.useMemo(()=>({getIsOnline:l,getIsSyncing:d,getLastUpdate:c,onConnectivityChange:e.on,forceSync:n}),[e.on,n,l,d,c]);return W.jsx(Ia.Provider,{value:u,children:a})}const ba=f.memo(Ca);function Ta(a){const t=f.useRef(void 0);return t.current==null&&(t.current=a.read().lastUpdateDate),t}function wa({children:a,s3UploadManager:t,sync:e}){const r=dt(),s=dt(),n=dt(),c=f.useMemo(()=>({onAnyUpdate:r.on,read:()=>e.read(),update:d=>e.update(d),forceReset:()=>e.forceReset()}),[e,r.on]);f.useEffect(()=>{const d=s.on(h=>{r.listenerCount()!==0&&r.emit({type:"any-update",updateVersion:h.updateVersion,config:{shouldReset:!1},changes:{attachment:h.attachment,category:h.category,label:h.label,task:h.task,space:h.space,board:h.board,section:h.section,userCustomView:h.userCustomView,card:h.card,tag:h.tag,myDayEntry:h.myDayEntry,user:h.user,groceryBoard:h.groceryBoard,grocerySection:h.grocerySection,groceryCard:h.groceryCard,cardChecklist:h.cardChecklist,checklistItem:h.checklistItem,cardAttachment:h.cardAttachment}})}),u=n.on(h=>{if(r.listenerCount()===0)return;const _=new Map,V=new Map,R=new Map,L=new Map,G=new Map,H=new Map,$=new Map,j=new Map,it=new Map,pt=new Map,gt=new Map,Et=new Map,kt=new Map,It=new Map,Ct=new Map,bt=new Map,Tt=new Map,wt=new Map,k=e.read(),{updates:I,deletions:C}=h;I.attachment.forEach(o=>{_.set(o,k.attachment.get(o))}),I.category.forEach(o=>{V.set(o,k.category.get(o))}),I.label.forEach(o=>{R.set(o,k.label.get(o))}),I.task.forEach(o=>{L.set(o,k.task.get(o))}),I.space.forEach(o=>{G.set(o,k.space.get(o))}),I.board.forEach(o=>{H.set(o,k.board.get(o))}),I.section.forEach(o=>{$.set(o,k.section.get(o))}),I.userCustomView.forEach(o=>{j.set(o,k.userCustomView.get(o))}),I.card.forEach(o=>{it.set(o,k.card.get(o))}),I.tag.forEach(o=>{pt.set(o,k.tag.get(o))}),I.myDayEntry.forEach(o=>{gt.set(o,k.myDayEntry.get(o))}),I.user.forEach(o=>{Et.set(o,k.user.get(o))}),I.groceryBoard.forEach(o=>{kt.set(o,k.groceryBoard.get(o))}),I.grocerySection.forEach(o=>{It.set(o,k.grocerySection.get(o))}),I.groceryCard.forEach(o=>{Ct.set(o,k.groceryCard.get(o))}),I.cardChecklist.forEach(o=>{bt.set(o,k.cardChecklist.get(o))}),I.checklistItem.forEach(o=>{Tt.set(o,k.checklistItem.get(o))}),I.cardAttachment.forEach(o=>{wt.set(o,k.cardAttachment.get(o))}),C.attachment.forEach(o=>void _.set(o,void 0)),C.category.forEach(o=>void V.set(o,void 0)),C.label.forEach(o=>void R.set(o,void 0)),C.task.forEach(o=>void L.set(o,void 0)),C.space.forEach(o=>void G.set(o,void 0)),C.board.forEach(o=>void H.set(o,void 0)),C.section.forEach(o=>void $.set(o,void 0)),C.userCustomView.forEach(o=>void j.set(o,void 0)),C.card.forEach(o=>void it.set(o,void 0)),C.tag.forEach(o=>void pt.set(o,void 0)),C.myDayEntry.forEach(o=>void gt.set(o,void 0)),C.user.forEach(o=>void Et.set(o,void 0)),C.groceryBoard.forEach(o=>void kt.set(o,void 0)),C.grocerySection.forEach(o=>void It.set(o,void 0)),C.groceryCard.forEach(o=>void Ct.set(o,void 0)),C.cardChecklist.forEach(o=>void bt.set(o,void 0)),C.checklistItem.forEach(o=>void Tt.set(o,void 0)),C.cardAttachment.forEach(o=>void wt.set(o,void 0)),r.emit({type:"any-update",updateVersion:h.updateVersion,config:{shouldReset:h.config.shouldReset},changes:{attachment:_,category:V,label:R,task:L,space:G,board:H,section:$,userCustomView:j,card:it,tag:pt,myDayEntry:gt,user:Et,groceryBoard:kt,grocerySection:It,groceryCard:Ct,cardChecklist:bt,checklistItem:Tt,cardAttachment:wt}})});return()=>{d(),u()}},[r,e,n,s]),f.useEffect(()=>e.on("will-update",s.emit),[e,s.emit]),f.useEffect(()=>e.on("sync",n.emit),[e,n.emit]);const l=f.useMemo(()=>W.jsx(ba,{sync:e,children:a}),[a,e]);return W.jsx(Ds.Provider,{value:c,children:W.jsx(as.Provider,{value:t,children:W.jsx(_a,{s3UploadManager:t,children:l})})})}const Ba=f.memo(wa),is=qe({key:"auth/atom",default:null}),Aa=je({key:"auth/authState",get:({get:a})=>a(is)}),ns=qe({key:"auth/token",default:null}),Da=je({key:"auth/hasAuthToken",get:({get:a})=>a(ns)!=null}),Ua={authState:Aa,authToken:ns,hasAuthToken:Da};function Pa(a,t){const[e,r]=f.useState(()=>a.isLoggedIn&&(t.isAfterFirstSync()||t.lastUpdateDate()>0));f.useEffect(()=>{if(!a.isLoggedIn)return;t.isAfterFirstSync()&&r(!0);const n=t.on("sync",function(){n(),r(!0)});return n},[a.isLoggedIn]);let s=e;return a.isLoggedIn||(e&&r(!1),s=!1),s}const Lt=(a,t)=>{switch(a){case"card":{const s=t;if(s.status===Jt.ARCHIVED||s.status===Jt.DELETED)return!1}break;case"section":const e=t;if(e.status===Qt.ARCHIVED||e.status===Qt.DELETED)return!1;break;case"label":if(t.isDeleted)return!1;break;case"groceryCard":{const s=t;if(s.status===Mt.Archived||s.status===Mt.Deleted)return!1}break;case"cardChecklist":if(t.status===me.DELETED)return!1;break;case"checklistItem":if(t.status===_e.DELETED)return!1;break;case"cardAttachment":if(t.status===Se.DELETED)return!1;break}return!0},va=a=>a[0]&&"position"in a[0],ce=(a,t)=>{const e=[...t.values()].filter(r=>Lt(a,r));return va(e)?e.sort((r,s)=>Ls.comparePositions(r.position,s.position)).map(r=>r.id):e.map(r=>r.id)},Wa=({children:a})=>{const{read:t,onAnyUpdate:e}=Us(),r=f.useRef(new Map);return W.jsx(vs,{storeKey:Ms,read:s=>{const[n,...c]=s.split("/"),l=c.join("/");if(Fs(Xt,n)){const d=t()[n];switch(l){case"ids":return ce(n,d);default:const u=d.get(l);return u&&Lt(n,u)?u:new At}}return new At},listen:({updateItems:s})=>e(n=>{for(const c of Xt)if(n.changes[c].size>0){const l=t()[c],d=new Map;for(const[u,h]of n.changes[c]){h&&Lt(c,h)?d.set(`${c}/${u}`,h):d.set(`${c}/${u}`,new At);let _=ce(c,l);(!r.current.has(c)||!Ns.isEqual(_,r.current.get(c)))&&(r.current.set(c,_),d.set(`${c}/ids`,_))}s(d)}}),children:a})},Va=({children:a})=>{const t=Os(),e=Rs(),r=te(is);M.useEffect(()=>{r({isLoggedIn:t.isLoggedIn,isNewUser:t.isNewUser,isPhoneVerified:t.isPhoneVerified,userDetails:t.userDetails,userEmail:t.userEmail,userProfileImageUrl:t.userProfileImageUrl,userSubscription:t.userSubscription})},[t,r]);const s=te(Ua.authToken);return M.useEffect(()=>{const n=()=>{s(e.getAuthToken())};n();const c=e.subscribe("loggedIn",n),l=e.subscribe("loggedOut",n);return()=>{c(),l()}},[e,s]),W.jsx(W.Fragment,{children:a})};export{ya as A,_t as C,Bt as F,Ra as S,Ua as a,ne as b,La as c,Ba as d,Va as e,Wa as f,Ia as g,ut as h,Oa as i,mt as j,St as k,Bs as l,Fa as m,Nt as n,Ws as o,Pa as u};
