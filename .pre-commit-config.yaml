# Pre-commit configuration for Exarp project
# Integrates Exarp's own tools for self-validation ("dogfooding")
#
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Standard Python checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
        args: ['--maxkb=500']
      - id: check-merge-conflict
      - id: detect-private-key

  # Python code formatting
  - repo: https://github.com/psf/black
    rev: 24.1.1
    hooks:
      - id: black
        language_version: python3

  # Python linting
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.2.1
    hooks:
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]

  # Local Exarp tools (dogfooding!)
  - repo: local
    hooks:
      # Quick docs health check
      - id: exarp-docs-health
        name: Exarp Docs Health Check
        entry: python -c "from project_management_automation.tools.docs_health import check_documentation_health; print(check_documentation_health())"
        language: python
        pass_filenames: false
        files: \.(md|rst)$
        stages: [commit]

      # Tag validation on task file changes
      - id: exarp-tag-validation
        name: Exarp Tag Validation
        entry: python -c "from project_management_automation.tools.tag_consolidation import consolidate_tags; print(consolidate_tags(dry_run=True))"
        language: python
        pass_filenames: false
        files: \.todo2/.*\.json$
        stages: [commit]

      # Security scan (quick mode for commits)
      - id: exarp-security-quick
        name: Exarp Security Scan (Quick)
        entry: python -c "from project_management_automation.tools.dependency_security import scan_dependency_security; print(scan_dependency_security())"
        language: python
        pass_filenames: false
        files: (requirements.*\.txt|pyproject\.toml|Cargo\.toml|package\.json)$
        stages: [commit]

      # Full alignment check on push
      - id: exarp-alignment
        name: Exarp Task Alignment
        entry: python -c "from project_management_automation.tools.todo2_alignment import analyze_todo2_alignment; print(analyze_todo2_alignment())"
        language: python
        pass_filenames: false
        stages: [push]

      # Project scorecard on push
      - id: exarp-scorecard
        name: Exarp Project Scorecard
        entry: python -c "from project_management_automation.tools.project_scorecard import generate_project_scorecard; print(generate_project_scorecard('json'))"
        language: python
        pass_filenames: false
        stages: [push]

      # MCP Tool Validation (prevents FastMCP issues)
      - id: exarp-tool-validation
        name: Exarp MCP Tool Validation
        entry: python -m project_management_automation.utils.tool_validator
        language: system
        pass_filenames: false
        files: project_management_automation/server\.py$
        stages: [commit, push]
        always_run: false

# CI configuration
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: [exarp-docs-health, exarp-tag-validation, exarp-security-quick, exarp-alignment, exarp-scorecard, exarp-tool-validation]
  submodules: false

